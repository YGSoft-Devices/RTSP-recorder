<!DOCTYPE html>
<!-- RTSP Recorder Web Interface - Version 2.33.02 -->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTSP Recorder - Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ app_version }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-video"></i>
                    <h1>RTSP Recorder</h1>
                </div>
                <div class="status-badge" id="service-status">
                    <span class="status-dot {{ 'active' if status == 'active' else 'inactive' }}"></span>
                    <span class="status-text">{{ status | capitalize }}</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Cards -->
            <section class="dashboard-cards">
                <!-- System Card (1st - most important) -->
                <div class="card info-card card-system">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-server"></i>
                        </div>
                        <h3>Syst?me</h3>
                    </div>
                    <div class="card-content">
                        <div class="system-info">
                            <div class="system-hostname" title="{{ system_info.get('hostname', 'N/A') }}">
                                <i class="fas fa-tag"></i> {{ system_info.get('hostname', 'N/A') }}
                            </div>
                            <div class="system-details">
                                <span title="Adresse IP"><i class="fas fa-network-wired"></i> {{ system_info.get('ip_addresses', ['N/A'])[0] }}</span>
                                <span title="Uptime"><i class="fas fa-clock"></i> {{ system_info.get('uptime', 'N/A') }}</span>
                            </div>
                            <div class="system-metrics">
                                <div class="metric" title="CPU">
                                    <i class="fas fa-microchip"></i>
                                    <span>{{ system_info.get('cpu_percent', 0) }}%</span>
                                </div>
                                <div class="metric" title="RAM">
                                    <i class="fas fa-memory"></i>
                                    <span>{{ system_info.get('ram_percent', 0) }}%</span>
                                </div>
                                {% if system_info.get('cpu_temp') %}
                                <div class="metric {% if system_info.get('cpu_temp', 0) > 70 %}hot{% elif system_info.get('cpu_temp', 0) > 55 %}warm{% endif %}" title="Temp?rature">
                                    <i class="fas fa-thermometer-half"></i>
                                    <span>{{ system_info.get('cpu_temp', 'N/A') }}?C</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Storage Card (2nd) -->
                <div class="card info-card card-storage">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-hdd"></i>
                        </div>
                        <h3>Stockage</h3>
                    </div>
                    <div class="card-content">
                        <div class="storage-info">
                            <div class="storage-main">
                                <span class="storage-value">{{ system_info.get('disk_used', 'N/A') }}</span>
                                <span class="storage-separator">/</span>
                                <span class="storage-total">{{ system_info.get('disk_total', 'N/A') }}</span>
                            </div>
                            <div class="storage-bar">
                                <div class="storage-bar-fill" style="width: {{ system_info.get('disk_percent_num', 0) }}%"></div>
                            </div>
                            <div class="storage-details">
                                <span><i class="fas fa-folder-open"></i> {{ system_info.get('recording_count', 0) }} fichiers</span>
                                <span><i class="fas fa-film"></i> {{ system_info.get('recording_size_mb', 0) }} Mo</span>
                                <span class="storage-free"><i class="fas fa-check-circle"></i> {{ system_info.get('disk_avail', 'N/A') }} libre</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- URL RTSP Card (3rd) -->
                <div class="card info-card card-rtsp">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <h3>URL RTSP</h3>
                    </div>
                    <div class="card-content">
                        {% if is_provisioned and rtsp_url_hostname %}
                        <div class="url-display-compact">
                            <div class="url-row">
                                <span class="url-badge primary">Principal</span>
                                <code class="url-text" title="{{ rtsp_url_hostname }}">{{ rtsp_url_hostname }}</code>
                                <button class="btn-icon" onclick="copyToClipboard('{{ rtsp_url_hostname }}')" title="Copier">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="url-row">
                                <span class="url-badge secondary">IP</span>
                                <code class="url-text" title="{{ rtsp_url }}">{{ rtsp_url }}</code>
                                <button class="btn-icon" onclick="copyToClipboard('{{ rtsp_url }}')" title="Copier">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="url-display-compact">
                            <div class="url-row single">
                                <code class="url-text" title="{{ rtsp_url }}">{{ rtsp_url }}</code>
                                <button class="btn-icon" onclick="copyRtspUrl()" title="Copier">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Service Control Card (4th) -->
                <div class="card control-card">
                    <h3><i class="fas fa-power-off"></i> Contr?le Services</h3>
                    <div class="service-selector">
                        <select id="service-select" class="service-select">
                            <option value="rpi-av-rtsp-recorder">RTSP Streaming</option>
                            <option value="rtsp-watchdog">Watchdog</option>
                            <option value="rpi-cam-onvif">ONVIF</option>
                            <option value="rpi-cam-webmanager">Web Manager</option>
                        </select>
                    </div>
                    <div class="control-buttons">
                        <button class="btn btn-success btn-service" onclick="controlServiceAction('start')">
                            <i class="fas fa-play"></i> D?marrer
                        </button>
                        <button class="btn btn-warning btn-service" onclick="controlServiceAction('restart')">
                            <i class="fas fa-sync"></i> Red?marrer
                        </button>
                        <button class="btn btn-danger btn-service" onclick="controlServiceAction('stop')">
                            <i class="fas fa-stop"></i> Arr?ter
                        </button>
                    </div>
                </div>
            </section>

            <!-- Configuration Tabs -->
            <section class="config-section">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="home">
                        <i class="fas fa-home"></i> Accueil
                    </button>
                    <button class="tab-btn" data-tab="rtsp">
                        <i class="fas fa-broadcast-tower"></i> RTSP
                    </button>
                    <button class="tab-btn" data-tab="onvif">
                        <i class="fas fa-eye"></i> ONVIF
                    </button>
                    <button class="tab-btn" data-tab="video">
                        <i class="fas fa-video"></i> Vid?o
                    </button>
                    <button class="tab-btn" data-tab="audio">
                        <i class="fas fa-microphone"></i> Audio
                    </button>
                    <button class="tab-btn" data-tab="recording">
                        <i class="fas fa-hdd"></i> Stockage
                    </button>
                    <button class="tab-btn" data-tab="files">
                        <i class="fas fa-film"></i> Enregistrements
                    </button>
                    <button class="tab-btn" data-tab="network">
                        <i class="fas fa-network-wired"></i> R?seau
                    </button>
                    <button class="tab-btn" data-tab="system">
                        <i class="fas fa-microchip"></i> Syst?me
                    </button>
                    <button class="tab-btn" data-tab="meeting">
                        <i class="fas fa-cloud-upload-alt"></i> Meeting
                    </button>
                    <button class="tab-btn" data-tab="advanced">
                        <i class="fas fa-cogs"></i> Avanc?
                    </button>
                    <button class="tab-btn" data-tab="logs">
                        <i class="fas fa-file-alt"></i> Logs
                    </button>
                    {% if debug_enabled %}
                    <button class="tab-btn" data-tab="debug">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                    {% endif %}
                </div>

                <form id="config-form">
                    <!-- Home Tab (new) -->
                    <div class="tab-content active" id="tab-home">
                        <div class="home-welcome">
                            <div class="welcome-header">
                                <i class="fas fa-video fa-3x"></i>
                                <h2>Bienvenue sur RTSP Recorder</h2>
                                <p class="welcome-subtitle">Interface de gestion pour cam?ra Raspberry Pi</p>
                            </div>
                            
                            <div class="home-grid">
                                <!-- Quick Status -->
                                <div class="home-card">
                                    <div class="home-card-header">
                                        <i class="fas fa-heartbeat"></i>
                                        <h3>?tat du syst?me</h3>
                                    </div>
                                    <div class="home-card-content">
                                        <div class="status-row">
                                            <span>Service RTSP</span>
                                            <span class="status-badge" id="home-rtsp-status">
                                                <span class="status-dot"></span>
                                                <span>Chargement...</span>
                                            </span>
                                        </div>
                                        <div class="status-row">
                                            <span>Service ONVIF</span>
                                            <span class="status-badge" id="home-onvif-status">
                                                <span class="status-dot"></span>
                                                <span>Chargement...</span>
                                            </span>
                                        </div>
                                        <div class="status-row">
                                            <span>Enregistrement</span>
                                            <span class="status-badge" id="home-recording-status">
                                                <span class="status-dot"></span>
                                                <span>Chargement...</span>
                                            </span>
                                        </div>
                                        <div class="status-row">
                                            <span>Meeting API</span>
                                            <span class="status-badge" id="home-meeting-status">
                                                <span class="status-dot"></span>
                                                <span>Chargement...</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Access -->
                                <div class="home-card">
                                    <div class="home-card-header">
                                        <i class="fas fa-bolt"></i>
                                        <h3>Acc?s rapide</h3>
                                    </div>
                                    <div class="home-card-content">
                                        <div class="quick-actions">
                                            <button type="button" class="quick-action-btn" onclick="switchToTab('rtsp')">
                                                <i class="fas fa-broadcast-tower"></i>
                                                <span>Config RTSP</span>
                                            </button>
                                            <button type="button" class="quick-action-btn" onclick="switchToTab('onvif')">
                                                <i class="fas fa-eye"></i>
                                                <span>Config ONVIF</span>
                                            </button>
                                            <button type="button" class="quick-action-btn" onclick="switchToTab('video')">
                                                <i class="fas fa-video"></i>
                                                <span>R?glages Vid?o</span>
                                            </button>
                                            <button type="button" class="quick-action-btn" onclick="switchToTab('network')">
                                                <i class="fas fa-network-wired"></i>
                                                <span>R?seau</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Device Info -->
                                <div class="home-card">
                                    <div class="home-card-header">
                                        <i class="fas fa-info-circle"></i>
                                        <h3>Informations device</h3>
                                    </div>
                                    <div class="home-card-content">
                                        <div class="info-row">
                                            <span class="info-label">Nom ONVIF</span>
                                            <span class="info-value" id="home-device-name">Chargement...</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">IP principale</span>
                                            <span class="info-value" id="home-device-ip">{{ system_info.get('ip', 'N/A') }}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Mod?le</span>
                                            <span class="info-value">{{ system_info.get('model', 'Raspberry Pi') }}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Uptime</span>
                                            <span class="info-value" id="home-uptime">{{ system_info.get('uptime', 'N/A') }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cloud Registration Status -->
                                <div class="home-card">
                                    <div class="home-card-header">
                                        <i class="fas fa-cloud"></i>
                                        <h3>Statut Cloud</h3>
                                    </div>
                                    <div class="home-card-content">
                                        {% if is_provisioned %}
                                        <div class="cloud-status cloud-registered">
                                            <div class="cloud-status-icon">
                                                <i class="fas fa-check-circle"></i>
                                            </div>
                                            <div class="cloud-status-text">
                                                <span class="cloud-status-title">Device enregistr?</span>
                                                <span class="cloud-status-subtitle">Connect? au cloud Meeting</span>
                                            </div>
                                        </div>
                                        <div class="cloud-details">
                                            <div class="info-row">
                                                <span class="info-label">Device Key</span>
                                                <span class="info-value cloud-key" id="home-device-key">{{ config.get('MEETING_DEVICE_KEY', 'N/A')[:12] }}...</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">Heartbeat</span>
                                                <span class="info-value" id="home-heartbeat-status">
                                                    <span class="status-dot status-active"></span> Actif
                                                </span>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="cloud-status cloud-unregistered">
                                            <div class="cloud-status-icon">
                                                <i class="fas fa-times-circle"></i>
                                            </div>
                                            <div class="cloud-status-text">
                                                <span class="cloud-status-title">Non enregistr?</span>
                                                <span class="cloud-status-subtitle">Device non provisionn?</span>
                                            </div>
                                        </div>
                                        <div class="cloud-action">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="switchToTab('meeting')">
                                                <i class="fas fa-cog"></i> Configurer
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Stream URLs -->
                                <div class="home-card home-card-wide">
                                    <div class="home-card-header">
                                        <i class="fas fa-link"></i>
                                        <h3>URLs de streaming</h3>
                                    </div>
                                    <div class="home-card-content">
                                        <div class="url-info-row">
                                            <span class="url-label"><i class="fas fa-video"></i> RTSP</span>
                                            <code class="url-value" id="home-rtsp-url">{{ rtsp_url }}</code>
                                            <button type="button" class="btn btn-icon btn-sm" onclick="copyToClipboard(document.getElementById('home-rtsp-url').textContent)">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <div class="url-info-row">
                                            <span class="url-label"><i class="fas fa-eye"></i> ONVIF</span>
                                            <code class="url-value" id="home-onvif-url">Chargement...</code>
                                            <button type="button" class="btn btn-icon btn-sm" onclick="copyToClipboard(document.getElementById('home-onvif-url').textContent)">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RTSP Tab -->
                    <div class="tab-content" id="tab-rtsp">
                        <div class="form-section">
                            <h4><i class="fas fa-video"></i> Configuration RTSP</h4>
                            <small class="section-help">Param?tres du serveur de streaming RTSP</small>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="RTSP_PORT">
                                        <i class="fas fa-plug"></i> Port RTSP
                                    </label>
                                    <input type="number" id="RTSP_PORT" name="RTSP_PORT" 
                                           value="{{ config.RTSP_PORT }}" min="1" max="65535">
                                    <small>Port d'?coute du serveur RTSP (d?faut: 8554)</small>
                                </div>
                                <div class="form-group">
                                    <label for="RTSP_PATH">
                                        <i class="fas fa-route"></i> Chemin RTSP
                                    </label>
                                    <input type="text" id="RTSP_PATH" name="RTSP_PATH" 
                                           value="{{ config.RTSP_PATH }}">
                                    <small>Chemin du flux (ex: stream ? rtsp://IP:port/stream)</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4><i class="fas fa-lock"></i> Authentification RTSP / ONVIF (partag?e)</h4>
                            <small class="section-help">
                                Les identifiants sont partag?s entre RTSP et ONVIF (WS-Security).
                                Si l'utilisateur ET le mot de passe sont d?finis, l'authentification est requise pour acc?der au flux RTSP.
                                Laissez vide pour un acc?s sans authentification.
                            </small>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="RTSP_USER">
                                        <i class="fas fa-user"></i> Utilisateur RTSP/ONVIF
                                    </label>
                                    <input type="text" id="RTSP_USER" name="RTSP_USER" 
                                           value="{{ config.RTSP_USER }}"
                                           placeholder="admin">
                                    <small>Nom d'utilisateur partag? RTSP/ONVIF (optionnel)</small>
                                </div>
                                <div class="form-group">
                                    <label for="RTSP_PASSWORD">
                                        <i class="fas fa-key"></i> Mot de passe RTSP/ONVIF
                                    </label>
                                    <div class="input-with-button">
                                        <input type="password" id="RTSP_PASSWORD" name="RTSP_PASSWORD" 
                                               value="{{ config.RTSP_PASSWORD }}"
                                               placeholder="????????">
                                        <button type="button" class="btn btn-icon" 
                                                onclick="togglePassword('RTSP_PASSWORD')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small>Mot de passe partag? RTSP/ONVIF (optionnel)</small>
                                </div>
                            </div>
                            
                            <div class="alert alert-info" id="rtsp-auth-status">
                                <i class="fas fa-info-circle"></i>
                                <span id="rtsp-auth-message">V?rification...</span>
                            </div>
                            
                            <div class="section-actions">
                                <button type="button" class="btn btn-primary" onclick="saveConfig()">
                                    <i class="fas fa-save"></i> Sauvegarder
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4><i class="fas fa-broadcast-tower"></i> Param?tres RTSP</h4>
                            <small class="section-help">Contr?lez le flux vid?o RTSP transmis et l'enregistrement, ind?pendamment de la cam?ra</small>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="VIDEO_FPS">
                                        <i class="fas fa-tachometer-alt"></i> Images/seconde
                                    </label>
                                    <input type="number" id="VIDEO_FPS" name="VIDEO_FPS" 
                                           value="{{ config.VIDEO_FPS }}" min="1" max="60">
                                    <small>Nombre d'images par seconde (FPS)</small>
                                </div>
                                <div class="form-group">
                                    <label for="H264_BITRATE_KBPS">
                                        <i class="fas fa-signal"></i> D?bit H264 (kbps)
                                    </label>
                                    <input type="number" id="H264_BITRATE_KBPS" name="H264_BITRATE_KBPS" 
                                           value="{{ config.H264_BITRATE_KBPS }}" min="500" max="8000">
                                    <small>D?bit vid?o (d?faut: 1200 pour Pi 3B+)</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="H264_KEYINT">
                                        <i class="fas fa-key"></i> Intervalle keyframes
                                    </label>
                                    <input type="number" id="H264_KEYINT" name="H264_KEYINT" 
                                           value="{{ config.H264_KEYINT }}" min="10" max="120">
                                    <small>Images cl?s (d?faut: 30)</small>
                                </div>
                                <div class="form-group">
                                    <label for="H264_PROFILE">
                                        <i class="fas fa-layer-group"></i> Profil H264 (CSI)
                                    </label>
                                    <select id="H264_PROFILE" name="H264_PROFILE">
                                        <option value="" {% if not config.H264_PROFILE %}selected{% endif %}>Auto</option>
                                        <option value="baseline" {% if config.H264_PROFILE == 'baseline' %}selected{% endif %}>Baseline</option>
                                        <option value="constrained baseline" {% if config.H264_PROFILE == 'constrained baseline' %}selected{% endif %}>Constrained baseline</option>
                                        <option value="main" {% if config.H264_PROFILE == 'main' %}selected{% endif %}>Main</option>
                                        <option value="high" {% if config.H264_PROFILE == 'high' %}selected{% endif %}>High</option>
                                    </select>
                                    <small>Profil H264 (CSI uniquement)</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="H264_QP">
                                        <i class="fas fa-sliders-h"></i> Quantizer H264 (CSI)
                                    </label>
                                    <input type="number" id="H264_QP" name="H264_QP" 
                                           value="{{ config.H264_QP }}" min="1" max="51" placeholder="Auto">
                                    <small>QP fixe 1-51 (vide = auto)</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="VIDEO_OVERLAY_ENABLE">
                                        <i class="fas fa-text-height"></i> Overlay RTSP
                                    </label>
                                    <select id="VIDEO_OVERLAY_ENABLE" name="VIDEO_OVERLAY_ENABLE">
                                        <option value="no" {% if config.VIDEO_OVERLAY_ENABLE != 'yes' %}selected{% endif %}>D?sactiv?</option>
                                        <option value="yes" {% if config.VIDEO_OVERLAY_ENABLE == 'yes' %}selected{% endif %}>Activ?</option>
                                    </select>
                                    <small>Overlay texte/date (USB + CSI)</small>
                                </div>
                                <div class="form-group">
                                    <label for="VIDEO_OVERLAY_TEXT">
                                        <i class="fas fa-align-left"></i> Texte overlay
                                    </label>
                                    <input type="text" id="VIDEO_OVERLAY_TEXT" name="VIDEO_OVERLAY_TEXT"
                                           value="{{ config.VIDEO_OVERLAY_TEXT }}" placeholder="{CAMERA_TYPE} {VIDEO_RESOLUTION}">
                                    <small>Tokens: {CAMERA_TYPE} {VIDEO_RESOLUTION} {VIDEO_FPS} {VIDEO_FORMAT} {VIDEO_DEVICE}</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="CSI_OVERLAY_MODE">
                                        <i class="fas fa-sliders-h"></i> Mode overlay CSI
                                    </label>
                                    <select id="CSI_OVERLAY_MODE" name="CSI_OVERLAY_MODE">
                                        <option value="software" {% if config.CSI_OVERLAY_MODE != 'libcamera' %}selected{% endif %}>Software (decode/encode)</option>
                                        <option value="libcamera" {% if config.CSI_OVERLAY_MODE == 'libcamera' %}selected{% endif %}>Libcamera (rpicam-vid)</option>
                                    </select>
                                    <small>Libcamera: pas de date/heure (overlay texte uniquement)</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="VIDEO_OVERLAY_POSITION">
                                        <i class="fas fa-map-pin"></i> Position texte
                                    </label>
                                    <select id="VIDEO_OVERLAY_POSITION" name="VIDEO_OVERLAY_POSITION">
                                        <option value="top-left" {% if config.VIDEO_OVERLAY_POSITION == 'top-left' %}selected{% endif %}>Haut gauche</option>
                                        <option value="top-right" {% if config.VIDEO_OVERLAY_POSITION == 'top-right' %}selected{% endif %}>Haut droite</option>
                                        <option value="bottom-left" {% if config.VIDEO_OVERLAY_POSITION == 'bottom-left' %}selected{% endif %}>Bas gauche</option>
                                        <option value="bottom-right" {% if config.VIDEO_OVERLAY_POSITION == 'bottom-right' %}selected{% endif %}>Bas droite</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="VIDEO_OVERLAY_SHOW_DATETIME">
                                        <i class="fas fa-clock"></i> Date/heure
                                    </label>
                                    <select id="VIDEO_OVERLAY_SHOW_DATETIME" name="VIDEO_OVERLAY_SHOW_DATETIME">
                                        <option value="no" {% if config.VIDEO_OVERLAY_SHOW_DATETIME != 'yes' %}selected{% endif %}>D?sactiv?</option>
                                        <option value="yes" {% if config.VIDEO_OVERLAY_SHOW_DATETIME == 'yes' %}selected{% endif %}>Activ?</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="VIDEO_OVERLAY_DATETIME_FORMAT">
                                        <i class="fas fa-calendar-alt"></i> Format date/heure
                                    </label>
                                    <input type="text" id="VIDEO_OVERLAY_DATETIME_FORMAT" name="VIDEO_OVERLAY_DATETIME_FORMAT"
                                           value="{{ config.VIDEO_OVERLAY_DATETIME_FORMAT }}" placeholder="%Y-%m-%d %H:%M:%S">
                                    <small>Format strftime</small>
                                </div>
                                <div class="form-group">
                                    <label for="VIDEO_OVERLAY_CLOCK_POSITION">
                                        <i class="fas fa-map-pin"></i> Position date/heure
                                    </label>
                                    <select id="VIDEO_OVERLAY_CLOCK_POSITION" name="VIDEO_OVERLAY_CLOCK_POSITION">
                                        <option value="top-left" {% if config.VIDEO_OVERLAY_CLOCK_POSITION == 'top-left' %}selected{% endif %}>Haut gauche</option>
                                        <option value="top-right" {% if config.VIDEO_OVERLAY_CLOCK_POSITION == 'top-right' %}selected{% endif %}>Haut droite</option>
                                        <option value="bottom-left" {% if config.VIDEO_OVERLAY_CLOCK_POSITION == 'bottom-left' %}selected{% endif %}>Bas gauche</option>
                                        <option value="bottom-right" {% if config.VIDEO_OVERLAY_CLOCK_POSITION == 'bottom-right' %}selected{% endif %}>Bas droite</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="VIDEO_OVERLAY_FONT_SIZE">
                                        <i class="fas fa-font"></i> Taille police
                                    </label>
                                    <input type="number" id="VIDEO_OVERLAY_FONT_SIZE" name="VIDEO_OVERLAY_FONT_SIZE"
                                           value="{{ config.VIDEO_OVERLAY_FONT_SIZE }}" min="1" max="64">
                                    <small>Taille de police (Sans)</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn btn-success btn-full" onclick="applyVideoSettings()">
                                <i class="fas fa-check"></i> Appliquer les param?tres RTSP
                            </button>
                            <small class="hint">Sauvegarde et red?marre le service RTSP avec les nouveaux param?tres</small>
                        </div>
                    </div>

                    <!-- ONVIF Tab (new separate tab) -->
                    <div class="tab-content" id="tab-onvif">
                        <div class="form-section">
                            <h4><i class="fas fa-eye"></i> Service ONVIF</h4>
                            <small class="section-help">
                                ONVIF permet la d?couverte automatique de la cam?ra par les enregistreurs NVR et logiciels compatibles (Synology Surveillance Station, Blue Iris, etc.).
                            </small>
                            
                            <div class="onvif-status" id="onvif-status">
                                <div class="status-indicator">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="toggle-label">
                                    <span><i class="fas fa-power-off"></i> Activer ONVIF</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="onvif_enabled" name="onvif_enabled"
                                               onchange="toggleOnvifConfig()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>
                            </div>
                            
                            <div id="onvif-config" style="display: none;">
                                <!-- ONVIF URL Info -->
                                <div class="info-box info-box-highlight">
                                    <h5><i class="fas fa-link"></i> URL ONVIF</h5>
                                    <div class="url-display">
                                        <code id="onvif-url-display">http://...</code>
                                        <button type="button" class="btn btn-icon btn-sm" onclick="copyOnvifUrl()">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <small>Utilisez cette URL pour ajouter la cam?ra dans votre NVR/logiciel ONVIF.</small>
                                </div>
                                
                                <!-- ONVIF Video Info Box -->
                                <div class="info-box" id="onvif-video-info">
                                    <h5><i class="fas fa-video"></i> Param?tres vid?o annonc?s</h5>
                                    <p class="info-text">
                                        Les param?tres vid?o rapport?s aux clients ONVIF sont automatiquement synchronis?s avec les r?glages de l'onglet Vid?o.
                                    </p>
                                    <div class="onvif-video-stats">
                                        <span><i class="fas fa-expand"></i> R?solution: <strong id="onvif-resolution">-</strong></span>
                                        <span><i class="fas fa-tachometer-alt"></i> FPS: <strong id="onvif-fps">-</strong></span>
                                        <span><i class="fas fa-chart-line"></i> Bitrate: <strong id="onvif-bitrate">-</strong></span>
                                    </div>
                                    <small class="hint">Modifiez ces valeurs dans l'onglet Vid?o, puis red?marrez le service ONVIF.</small>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="onvif_port">
                                            <i class="fas fa-plug"></i> Port ONVIF
                                        </label>
                                        <input type="number" id="onvif_port" name="onvif_port" 
                                               value="8080" min="1" max="65535">
                                        <small>Port du service ONVIF (d?faut: 8080)</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="onvif_name">
                                            <i class="fas fa-tag"></i> Nom de la cam?ra
                                            <span id="onvif_name_source" class="badge badge-info" style="font-size: 0.7em; margin-left: 5px; display: none;">Meeting API</span>
                                        </label>
                                        <input type="text" id="onvif_name" name="onvif_name" 
                                               placeholder="UNPROVISIONNED" readonly>
                                        <small id="onvif_name_hint">Nom r?cup?r? automatiquement depuis Meeting API (product_serial)</small>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="onvif_username">
                                            <i class="fas fa-user"></i> Identifiant ONVIF
                                        </label>
                                        <input type="text" id="onvif_username" placeholder="admin">
                                        <small>Utilis? si les identifiants RTSP sont vides</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="onvif_password">
                                            <i class="fas fa-key"></i> Mot de passe ONVIF
                                        </label>
                                        <div class="input-with-button">
                                            <input type="password" id="onvif_password" placeholder="???????? (inchang? si vide)">
                                            <button type="button" class="btn btn-icon" onclick="togglePassword('onvif_password')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <small>WS-Security ONVIF (ignor? si RTSP auth d?finie)</small>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="onvif_rtsp_port">
                                            <i class="fas fa-network-wired"></i> Port RTSP annonc?
                                        </label>
                                        <input type="number" id="onvif_rtsp_port" min="1" max="65535" value="8554">
                                        <small>Port RTSP annonc? aux clients ONVIF</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="onvif_rtsp_path">
                                            <i class="fas fa-link"></i> Chemin RTSP annonc?
                                        </label>
                                        <input type="text" id="onvif_rtsp_path" placeholder="/stream">
                                        <small>Chemin RTSP annonc? aux clients ONVIF</small>
                                    </div>
                                </div>
                                
                                <div class="info-box info-box-highlight">
                                    <h5><i class="fas fa-lock"></i> Identifiants partag?s RTSP/ONVIF</h5>
                                    <p class="info-text">
                                        Si des identifiants RTSP sont d?finis, ils sont automatiquement utilis?s pour ONVIF (WS-Security).
                                        Sinon, vous pouvez les d?finir ci-dessus.
                                    </p>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="switchToTab('rtsp')">
                                        <i class="fas fa-arrow-right"></i> Aller aux identifiants RTSP
                                    </button>
                                </div>
                                
                                <div class="button-group">
                                    <button type="button" class="btn btn-primary" onclick="saveOnvifConfig()">
                                        <i class="fas fa-save"></i> Sauvegarder
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="restartOnvifService()">
                                        <i class="fas fa-sync"></i> Red?marrer le service
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ONVIF Help Section -->
                            <div class="help-section">
                                <h5><i class="fas fa-question-circle"></i> Aide ONVIF</h5>
                                <div class="help-content">
                                    <p><strong>Qu'est-ce que ONVIF ?</strong></p>
                                    <p>ONVIF est un standard permettant aux cam?ras IP d'?tre d?tect?es et configur?es automatiquement par les logiciels de vid?osurveillance.</p>
                                    <p><strong>Logiciels compatibles :</strong></p>
                                    <ul>
                                        <li>Synology Surveillance Station</li>
                                        <li>Blue Iris</li>
                                        <li>QNAP QVR</li>
                                        <li>iSpy / Agent DVR</li>
                                        <li>Et tout logiciel compatible ONVIF Profile S</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Video Tab -->
                    <div class="tab-content" id="tab-video">
                        <!-- Video Preview Section -->
                        <div class="form-section preview-section">
                            <h4><i class="fas fa-eye"></i> Aper?u en direct</h4>
                            <small class="section-help">Visualisez le flux de la cam?ra en temps r?el</small>
                            
                            <div class="preview-container">
                                <div class="preview-wrapper" id="preview-wrapper">
                                    <div class="preview-placeholder" id="preview-placeholder">
                                        <i class="fas fa-video-slash"></i>
                                        <p>Aper?u non d?marr?</p>
                                        <small>Cliquez sur "D?marrer" pour voir le flux</small>
                                    </div>
                                    <img id="preview-stream" class="preview-stream" style="display: none;" alt="Preview">
                                </div>
                                <div class="preview-controls">
                                    <div class="preview-buttons">
                                        <button type="button" class="btn btn-success" id="btn-preview-start" onclick="startPreview()">
                                            <i class="fas fa-play"></i> D?marrer
                                        </button>
                                        <button type="button" class="btn btn-danger" id="btn-preview-stop" onclick="stopPreview()" style="display: none;">
                                            <i class="fas fa-stop"></i> Arr?ter
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="takeSnapshot()">
                                            <i class="fas fa-camera"></i> Capture
                                        </button>
                                    </div>
                                    <div class="preview-options">
                                        <label>
                                            <span>Source:</span>
                                            <select id="preview-source">
                                                <option value="auto" selected>Auto (recommand?)</option>
                                                <option value="rtsp">Flux RTSP</option>
                                                <option value="camera">Cam?ra directe</option>
                                            </select>
                                        </label>
                                        <label>
                                            <span>Qualit?:</span>
                                            <select id="preview-quality">
                                                <option value="320x240">320x240 (Basse)</option>
                                                <option value="640x480" selected>640x480 (Moyenne)</option>
                                                <option value="800x600">800x600 (Haute)</option>
                                            </select>
                                        </label>
                                    </div>
                                    <div class="preview-status">
                                        <span id="preview-status-text">
                                            <i class="fas fa-circle preview-status-dot inactive"></i> Inactif
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Video Device Section (first - camera selection) -->
                        <div class="form-section">
                            <h4><i class="fas fa-camera"></i> P?riph?rique vid?o</h4>
                            <small class="section-help">S?lectionnez d'abord la source vid?o (cam?ra USB ou CSI)</small>
                            
                            <div class="form-group">
                                <label for="VIDEO_DEVICE">
                                    <i class="fas fa-camera"></i> P?riph?rique vid?o
                                </label>
                                <div class="input-with-button">
                                    <input type="text" id="VIDEO_DEVICE" name="VIDEO_DEVICE" 
                                           value="{{ config.VIDEO_DEVICE }}">
                                    <input type="hidden" id="VIDEO_FORMAT" name="VIDEO_FORMAT" value="{{ config.VIDEO_FORMAT or 'auto' }}">
                                    <button type="button" class="btn btn-secondary" onclick="detectCameras()">
                                        <i class="fas fa-search"></i> D?tecter
                                    </button>
                                </div>
                                <small>Chemin du p?riph?rique USB (ex: /dev/video0)</small>
                                <div id="camera-list" class="detection-list"></div>
                            </div>
                            <div class="form-group">
                                <label for="CAMERA_DEVICE">
                                    <i class="fas fa-sliders-h"></i> P?riph?rique cam?ra (legacy)
                                </label>
                                <input type="text" id="CAMERA_DEVICE" name="CAMERA_DEVICE" 
                                       value="{{ config.get('CAMERA_DEVICE', config.VIDEO_DEVICE) }}">
                                <small>Ancien champ utilis? par certains scripts - laissez identique ? VIDEO_DEVICE</small>
                            </div>
                            <div class="form-group">
                                <label for="CAMERA_TYPE">
                                    <i class="fas fa-camera"></i> Type de Cam?ra
                                </label>
                                <div class="camera-type-toggle">
                                    <input type="radio" id="cam_usb" name="CAMERA_TYPE" value="usb" 
                                        onchange="onCameraTypeChange()"
                                        {{ 'checked' if config.CAMERA_TYPE == 'usb' or config.CAMERA_TYPE == 'auto' }}>
                                    <label for="cam_usb" class="toggle-btn" title="Cam?ra USB (Webcam)">
                                        <i class="fab fa-usb"></i> USB
                                    </label>
                                    
                                    <input type="radio" id="cam_csi" name="CAMERA_TYPE" value="csi" 
                                        onchange="onCameraTypeChange()"
                                        {{ 'checked' if config.CAMERA_TYPE == 'csi' }}>
                                    <label for="cam_csi" class="toggle-btn" title="Cam?ra CSI (Nappe)">
                                        <i class="fas fa-microchip"></i> CSI
                                    </label>
                                </div>
                                <small>S?lectionnez le type de cam?ra (Red?marrage requis pour appliquer)</small>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="CSI_ENABLE">
                                        <i class="fas fa-microchip"></i> Cam?ra CSI
                                    </label>
                                    <select id="CSI_ENABLE" name="CSI_ENABLE">
                                        <option value="auto" {{ 'selected' if config.CSI_ENABLE == 'auto' or config.CSI_ENABLE not in ['yes', 'no'] }}>Auto</option>
                                        <option value="yes" {{ 'selected' if config.CSI_ENABLE == 'yes' }}>Activ?</option>
                                        <option value="no" {{ 'selected' if config.CSI_ENABLE == 'no' }}>D?sactiv?</option>
                                    </select>
                                    <small>Autoriser ou bloquer la cam?ra CSI</small>
                                </div>
                                <div class="form-group">
                                    <label for="USB_ENABLE">
                                        <i class="fab fa-usb"></i> Cam?ra USB
                                    </label>
                                    <select id="USB_ENABLE" name="USB_ENABLE">
                                        <option value="auto" {{ 'selected' if config.USB_ENABLE == 'auto' or config.USB_ENABLE not in ['yes', 'no'] }}>Auto</option>
                                        <option value="yes" {{ 'selected' if config.USB_ENABLE == 'yes' }}>Activ?</option>
                                        <option value="no" {{ 'selected' if config.USB_ENABLE == 'no' }}>D?sactiv?</option>
                                    </select>
                                    <small>Autoriser ou bloquer la cam?ra USB</small>
                                </div>
                            </div>
                            <small>Utilis? uniquement quand le type de cam?ra est sur Auto</small>
                        </div>
                        
                        <!-- Resolution Selection (second - camera format) -->
                        <div class="form-section">
                            <h4><i class="fas fa-expand-arrows-alt"></i> R?solution vid?o</h4>
                            <small class="section-help">S?lectionnez une r?solution parmi celles support?es par votre cam?ra</small>
                            
                            <div class="resolution-selector">
                                <div class="form-group">
                                    <label for="resolution-select">
                                        <i class="fas fa-list"></i> R?solution
                                        <span id="resolution-loading" class="loading-indicator" style="display: none;">
                                            <i class="fas fa-spinner fa-spin"></i> D?tection...
                                        </span>
                                    </label>
                                    <select id="resolution-select" class="resolution-dropdown" onchange="onResolutionSelectChange(true)">
                                        <option value="">-- Chargement des r?solutions --</option>
                                    </select>
                                    <small>Format ? R?solution ? FPS max</small>
                                </div>
                                
                                <div class="resolution-details" id="resolution-details" style="display: none;">
                                    <div class="detail-row">
                                        <span class="detail-label">Format:</span>
                                        <span class="detail-value" id="detail-format">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">R?solution:</span>
                                        <span class="detail-value" id="detail-resolution">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">M?gapixels:</span>
                                        <span class="detail-value" id="detail-megapixels">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">FPS disponibles:</span>
                                        <span class="detail-value" id="detail-fps">-</span>
                                    </div>
                                </div>
                                
                                <div class="manual-override">
                                    <label class="toggle-label">
                                        <span><i class="fas fa-edit"></i> Mode manuel</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="manual-resolution-mode" onchange="toggleManualResolution()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </label>
                                    <small>Activer pour saisir une r?solution personnalis?e</small>
                                </div>
                            </div>
                            
                            <div class="manual-resolution-fields" id="manual-resolution-fields" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="VIDEO_WIDTH">
                                            <i class="fas fa-arrows-alt-h"></i> Largeur
                                        </label>
                                        <input type="number" id="VIDEO_WIDTH" name="VIDEO_WIDTH" 
                                               value="{{ config.VIDEO_WIDTH }}" min="320" max="4096">
                                        <small>Largeur en pixels</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="VIDEO_HEIGHT">
                                            <i class="fas fa-arrows-alt-v"></i> Hauteur
                                        </label>
                                        <input type="number" id="VIDEO_HEIGHT" name="VIDEO_HEIGHT" 
                                               value="{{ config.VIDEO_HEIGHT }}" min="240" max="2160">
                                        <small>Hauteur en pixels</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Camera Controls Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-sliders-h"></i> Contr?les Cam?ra</h4>
                            <small class="section-help">Ajustez les param?tres de la cam?ra en temps r?el</small>
                            
                            <div class="camera-controls" id="camera-controls">
                                <div class="form-group">
                                    <label>
                                        <i class="fas fa-crosshairs"></i> Autofocus
                                    </label>
                                    <div class="autofocus-control">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="camera_autofocus" 
                                                   onchange="setCameraAutofocus(this.checked)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span id="autofocus-status" class="control-status">Chargement...</span>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="triggerOneShotFocus()" title="Focus ponctuel">
                                            <i class="fas fa-bullseye"></i> Focus
                                        </button>
                                    </div>
                                    <small>D?sactiver pour ?viter le bruit m?canique. Bouton "Focus" = mise au point unique puis verrouillage.</small>
                                </div>
                                
                                <div class="form-group" id="manual-focus-group" style="display: none;">
                                    <label for="camera_focus">
                                        <i class="fas fa-search-plus"></i> Focus manuel
                                    </label>
                                    <div class="range-control">
                                        <input type="range" id="camera_focus" min="0" max="255" value="30"
                                               onchange="setCameraFocus(this.value)">
                                        <span id="focus-value" class="range-value">30</span>
                                    </div>
                                    <small>Ajustez manuellement la mise au point (0 = proche, 255 = loin)</small>
                                </div>
                                
                                <div class="camera-controls-buttons">
                                    <button type="button" class="btn btn-secondary" onclick="loadCameraControls()">
                                        <i class="fas fa-sync"></i> Actualiser
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="showAdvancedCameraControls()">
                                        <i class="fas fa-cogs"></i> Param?tres avanc?s
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Camera Controls (Modal/Collapsible) -->
                        <div class="form-section collapsible" id="advanced-camera-section" style="display: none;">
                            <h4 onclick="toggleSection('advanced-camera-section')">
                                <i class="fas fa-chevron-down"></i>
                                <i class="fas fa-cogs"></i> Param?tres Cam?ra Avanc?s
                            </h4>
                            <small class="section-help">Tous les contr?les disponibles pour cette cam?ra</small>
                            
                            <div id="csi-controls-notice" class="info-box" style="display: none;">
                                <i class="fas fa-info-circle"></i>
                                <span>Les cam?ras CSI/PiCam utilisent libcamera et ne supportent pas les contr?les v4l2 avanc?s. Les r?glages d'image doivent ?tre configur?s via les param?tres libcamera.</span>
                            </div>
                            <div id="advanced-camera-controls" class="advanced-controls-grid">
                                <p class="loading-text"><i class="fas fa-spinner fa-spin"></i> Chargement des contr?les...</p>
                            </div>
                            
                            <div class="advanced-controls-actions">
                                <button type="button" class="btn btn-secondary" onclick="loadAdvancedCameraControls()">
                                    <i class="fas fa-sync"></i> Rafra?chir
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetAdvancedControls()">
                                    <i class="fas fa-undo"></i> Valeurs par d?faut
                                </button>
                                <button type="button" class="btn btn-warning" onclick="restartRtspStream()" title="Red?marrer le flux si les changements ne sont pas visibles">
                                    <i class="fas fa-redo"></i> Red?marrer flux
                                </button>
                            </div>
                        </div>
                        
                        <!-- Camera Profiles Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-clock"></i> Profils Cam?ra (Jour/Nuit)</h4>
                            <small class="section-help">Appliquez automatiquement des r?glages selon l'heure</small>
                            
                              <div class="form-group">
                                  <label>
                                      <i class="fas fa-power-off"></i> Scheduler de profils
                                  </label>
                                  <div class="scheduler-control">
                                      <label class="toggle-switch">
                                          <input type="checkbox" id="profiles_scheduler_enabled" 
                                                 onchange="toggleProfilesScheduler(this.checked)">
                                          <span class="toggle-slider"></span>
                                      </label>
                                      <span id="scheduler-status" class="control-status">D?sactiv?</span>
                                  </div>
                                  <small>Active le changement automatique de profil selon les horaires d?finis</small>
                              </div>
                              <div class="form-group">
                                  <label for="CAMERA_PROFILES_FILE">
                                      <i class="fas fa-file-alt"></i> Fichier des profils
                                  </label>
                                  <input type="text" id="CAMERA_PROFILES_FILE" name="CAMERA_PROFILES_FILE" 
                                         value="{{ config.CAMERA_PROFILES_FILE }}">
                                  <small>Chemin du fichier JSON contenant les profils cam?ra</small>
                              </div>
                            
                            <div id="camera-profiles-list" class="profiles-list">
                                <p class="loading-text"><i class="fas fa-spinner fa-spin"></i> Chargement des profils...</p>
                            </div>
                            
                            <div class="profiles-actions">
                                <button type="button" class="btn btn-secondary" onclick="loadCameraProfiles()">
                                    <i class="fas fa-sync"></i> Rafra?chir
                                </button>
                                <button type="button" class="btn btn-primary" onclick="showAddProfileModal()">
                                    <i class="fas fa-plus"></i> Nouveau profil
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Tab -->
                    <div class="tab-content" id="tab-audio">
                        <div class="form-group">
                            <label>
                                <i class="fas fa-volume-up"></i> Capture Audio
                            </label>
                            <div class="radio-toggle-group">
                                <label class="radio-toggle">
                                    <input type="radio" name="AUDIO_ENABLE" value="no" {{ 'checked' if config.AUDIO_ENABLE == 'no' }}>
                                    <span class="radio-toggle-btn">
                                        <i class="fas fa-volume-mute"></i> D?sactiv?
                                    </span>
                                </label>
                                <label class="radio-toggle">
                                    <input type="radio" name="AUDIO_ENABLE" value="auto" {{ 'checked' if config.AUDIO_ENABLE == 'auto' or config.AUDIO_ENABLE not in ['yes', 'no'] }}>
                                    <span class="radio-toggle-btn">
                                        <i class="fas fa-magic"></i> Auto
                                    </span>
                                </label>
                                <label class="radio-toggle">
                                    <input type="radio" name="AUDIO_ENABLE" value="yes" {{ 'checked' if config.AUDIO_ENABLE == 'yes' }}>
                                    <span class="radio-toggle-btn">
                                        <i class="fas fa-volume-up"></i> Activ?
                                    </span>
                                </label>
                            </div>
                            <small>Auto d?tecte automatiquement si un microphone USB est connect?</small>
                        </div>
                        <div class="form-group">
                            <label for="AUDIO_DEVICE">
                                <i class="fas fa-microphone"></i> P?riph?rique audio
                            </label>
                            <div class="input-with-button">
                                <input type="text" id="AUDIO_DEVICE" name="AUDIO_DEVICE" 
                                       value="{{ config.AUDIO_DEVICE }}">
                                <button type="button" class="btn btn-secondary" onclick="detectAudio()">
                                    <i class="fas fa-search"></i> D?tecter
                                </button>
                            </div>
                            <small>auto ou p?riph?rique ALSA (ex: plughw:1,0)</small>
                            <div id="audio-list" class="detection-list"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="AUDIO_RATE">
                                    <i class="fas fa-wave-square"></i> Fr?quence
                                </label>
                                <select id="AUDIO_RATE" name="AUDIO_RATE">
                                    <option value="22050" {{ 'selected' if config.AUDIO_RATE == '22050' }}>22050 Hz</option>
                                    <option value="44100" {{ 'selected' if config.AUDIO_RATE == '44100' }}>44100 Hz</option>
                                    <option value="48000" {{ 'selected' if config.AUDIO_RATE == '48000' }}>48000 Hz</option>
                                </select>
                                <small>Fr?quence d'?chantillonnage</small>
                            </div>
                            <div class="form-group">
                                <label for="AUDIO_CHANNELS">
                                    <i class="fas fa-headphones"></i> Canaux
                                </label>
                                <select id="AUDIO_CHANNELS" name="AUDIO_CHANNELS">
                                    <option value="1" {{ 'selected' if config.AUDIO_CHANNELS == '1' }}>Mono</option>
                                    <option value="2" {{ 'selected' if config.AUDIO_CHANNELS == '2' }}>St?r?o</option>
                                </select>
                                <small>Nombre de canaux audio</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="AUDIO_BITRATE_KBPS">
                                <i class="fas fa-signal"></i> D?bit audio (kbps)
                            </label>
                            <input type="number" id="AUDIO_BITRATE_KBPS" name="AUDIO_BITRATE_KBPS" 
                                   value="{{ config.AUDIO_BITRATE_KBPS }}" min="32" max="320">
                            <small>D?bit audio AAC en kbps (d?faut: 64)</small>
                        </div>
                        <div class="form-group">
                            <label for="AUDIO_GAIN">
                                <i class="fas fa-volume-up"></i> Amplification audio
                            </label>
                            <div class="slider-with-value">
                                <input type="range" id="AUDIO_GAIN" name="AUDIO_GAIN" 
                                       min="0" max="3" step="0.1"
                                       value="{{ config.AUDIO_GAIN|default('1.0') }}"
                                       oninput="updateAudioGainDisplay(this.value)">
                                <span id="AUDIO_GAIN_VALUE" class="slider-value">{{ config.AUDIO_GAIN|default('1.0') }}x</span>
                            </div>
                            <small>0 = muet, 1.0 = normal, 2.0 = x2, 3.0 = x3 (attention ? la saturation)</small>
                        </div>
                        
                        <div class="section-actions">
                            <button type="button" class="btn btn-primary" onclick="applyAudioConfig()">
                                <i class="fas fa-check"></i> Appliquer
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>

                    <!-- Recording Tab -->
                    <div class="tab-content" id="tab-recording">
                        <div class="led-info-box" style="margin-bottom: 20px;">
                            <i class="fas fa-info-circle"></i>
                            <span>
                                <strong>Note:</strong> L'enregistrement local via le serveur RTSP n'est pas support? avec test-launch.<br>
                                Pour enregistrer, utilisez une commande externe :<br>
                                <code style="background: var(--bg-color); padding: 4px 8px; border-radius: 4px; display: block; margin-top: 8px;">
                                    ffmpeg -i rtsp://localhost:8554/stream -c copy -f segment -segment_time 300 rec_%03d.ts
                                </code>
                            </span>
                        </div>
                        
                        <div class="form-group">
                            <label for="RECORD_ENABLE">
                                <i class="fas fa-circle-dot"></i> Enregistrement local
                            </label>
                            <select id="RECORD_ENABLE" name="RECORD_ENABLE">
                                <option value="no" {{ 'selected' if config.RECORD_ENABLE == 'no' }}>D?sactiv? (recommand?)</option>
                                <option value="yes" {{ 'selected' if config.RECORD_ENABLE == 'yes' }}>Activ?</option>
                            </select>
                            <small>L'enregistrement interne est d?sactiv? pour la stabilit? du flux RTSP</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="RECORD_DIR">
                                <i class="fas fa-folder"></i> R?pertoire d'enregistrement
                            </label>
                            <input type="text" id="RECORD_DIR" name="RECORD_DIR" 
                                   value="{{ config.RECORD_DIR }}">
                            <small>Chemin o? stocker les enregistrements (si activ?)</small>
                        </div>
                        <div class="form-group">
                            <label for="SEGMENT_SECONDS">
                                <i class="fas fa-clock"></i> Dur?e des segments (secondes)
                            </label>
                            <input type="number" id="SEGMENT_SECONDS" name="SEGMENT_SECONDS" 
                                   value="{{ config.SEGMENT_SECONDS }}" min="30" max="3600">
                            <small>Dur?e de chaque fichier en secondes (d?faut: 300 = 5 min)</small>
                        </div>
                          <div class="form-group">
                              <label for="MIN_FREE_DISK_MB">
                                  <i class="fas fa-hdd"></i> Espace libre minimum (Mo)
                              </label>
                              <input type="number" id="MIN_FREE_DISK_MB" name="MIN_FREE_DISK_MB" 
                                     value="{{ config.MIN_FREE_DISK_MB }}" min="0" max="1000000">
                              <small>Espace disque libre ? conserver. Les enregistrements les plus anciens seront supprim?s pour respecter cette limite. 0 = pas de limite.</small>
                          </div>
                          <div class="form-group">
                              <label for="MAX_DISK_MB">
                                  <i class="fas fa-database"></i> Espace disque maximum (Mo)
                              </label>
                              <input type="number" id="MAX_DISK_MB" name="MAX_DISK_MB" 
                                     value="{{ config.MAX_DISK_MB }}" min="0" max="1000000">
                              <small>0 = pas de limite. Si d?fini, l'espace total utilis? par les enregistrements est plafonn?.</small>
                          </div>
                        
                        <div class="section-actions">
                            <button type="button" class="btn btn-primary" onclick="saveConfig()">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>

                    <!-- Files Tab (Recording Files Management) -->
                    <div class="tab-content" id="tab-files">
                        <div class="platform-info" style="margin-bottom: 20px;">
                            <i class="fas fa-folder-open"></i>
                            <span>Gestion des fichiers enregistr?s - <strong>Lecture, Verrouillage, T?l?chargement et Suppression</strong></span>
                        </div>

                        <!-- Storage Info Banner -->
                        <div class="files-storage-banner" id="files-storage-info">
                            <div class="storage-stat">
                                <i class="fas fa-film"></i>
                                <span class="stat-value" id="files-total-count">-</span>
                                <span class="stat-label">fichiers</span>
                            </div>
                            <div class="storage-stat">
                                <i class="fas fa-database"></i>
                                <span class="stat-value" id="files-total-size">-</span>
                                <span class="stat-label">utilis?s</span>
                            </div>
                            <div class="storage-stat">
                                <i class="fas fa-hdd"></i>
                                <span class="stat-value" id="files-disk-available">-</span>
                                <span class="stat-label">disponibles</span>
                            </div>
                            <div class="storage-stat">
                                <i class="fas fa-chart-pie"></i>
                                <span class="stat-value" id="files-disk-used">-</span>
                                <span class="stat-label">utilisation</span>
                            </div>
                            <div class="storage-stat">
                                <i class="fas fa-server"></i>
                                <span class="stat-value" id="files-disk-total">-</span>
                                <span class="stat-label">total</span>
                            </div>
                            <div class="storage-stat storage-quota" id="files-quota-info" style="display: none;">
                                <!-- Populated by JS when quota is configured -->
                            </div>
                            <div class="storage-stat storage-quota" id="files-max-quota-info" style="display: none;">
                                <!-- Populated by JS when quota is configured -->
                            </div>
                            <div class="storage-stat">
                                <i class="fas fa-folder"></i>
                                <span class="stat-value stat-path" id="files-directory" title="">-</span>
                                <span class="stat-label">r?pertoire</span>
                            </div>
                        </div>

                        <!-- Files Actions Bar -->
                        <div class="files-actions-bar">
                            <div class="files-actions-left">
                                <button type="button" class="btn btn-secondary" onclick="loadFilesList()">
                                    <i class="fas fa-sync"></i> Actualiser
                                </button>
                                <div class="files-select-all">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="files-select-all" onchange="toggleSelectAllFiles()">
                                        <span>Tout s?lectionner</span>
                                    </label>
                                </div>
                            </div>
                            <div class="files-actions-right">
                                <button type="button" class="btn btn-info" onclick="lockSelectedFiles()" title="Verrouiller les fichiers s?lectionn?s">
                                    <i class="fas fa-lock"></i> Verrouiller
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="unlockSelectedFiles()" title="D?verrouiller les fichiers s?lectionn?s">
                                    <i class="fas fa-lock-open"></i> D?verrouiller
                                </button>
                                <button type="button" class="btn btn-danger" onclick="deleteSelectedFiles()" title="Supprimer les fichiers s?lectionn?s">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        </div>

                        <!-- Filter and Sort -->
                        <div class="files-filter-bar">
                            <div class="filter-group">
                                <label><i class="fas fa-filter"></i> Filtrer:</label>
                                <select id="files-filter" onchange="applyFilesFilter()">
                                    <option value="all">Tous les fichiers</option>
                                    <option value="locked">Verrouill?s uniquement</option>
                                    <option value="unlocked">Non verrouill?s uniquement</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label><i class="fas fa-sort"></i> Trier par:</label>
                                <select id="files-sort" onchange="applyFilesSort()">
                                    <option value="date-desc">Date (r?cent ? ancien)</option>
                                    <option value="date-asc">Date (ancien ? r?cent)</option>
                                    <option value="name-asc">Nom (A ? Z)</option>
                                    <option value="name-desc">Nom (Z ? A)</option>
                                    <option value="size-desc">Taille (grand ? petit)</option>
                                    <option value="size-asc">Taille (petit ? grand)</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label><i class="fas fa-search"></i></label>
                                <input type="text" id="files-search" placeholder="Rechercher..." oninput="applyFilesSearch()">
                            </div>
                        </div>

                        <!-- Files Grid -->
                        <div class="files-grid-container">
                            <div id="files-list" class="files-grid">
                                <div class="files-loading">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement des fichiers...
                                </div>
                            </div>
                            
                            <!-- Pagination Controls -->
                            <div class="files-pagination" id="files-pagination">
                                <div class="pagination-info">
                                    <span id="pagination-range">-</span> sur <span id="pagination-total">0</span> fichiers
                                </div>
                                <div class="pagination-controls">
                                    <button type="button" class="btn-pagination" id="btn-first-page" onclick="goToPage(1)" title="Premi?re page" disabled>
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button type="button" class="btn-pagination" id="btn-prev-page" onclick="goToPrevPage()" title="Page pr?c?dente" disabled>
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <span class="pagination-pages" id="pagination-pages">
                                        <!-- Generated dynamically -->
                                    </span>
                                    <button type="button" class="btn-pagination" id="btn-next-page" onclick="goToNextPage()" title="Page suivante" disabled>
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button type="button" class="btn-pagination" id="btn-last-page" onclick="goToPage('last')" title="Derni?re page" disabled>
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                                <div class="pagination-per-page">
                                    <label>Par page:</label>
                                    <select id="files-per-page" onchange="changePerPage()">
                                        <option value="10">10</option>
                                        <option value="20" selected>20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Selection Info -->
                        <div class="files-selection-info" id="files-selection-info" style="display: none;">
                            <span><strong id="files-selected-count">0</strong> fichier(s) s?lectionn?(s)</span>
                            <span class="separator">|</span>
                            <span>Taille totale: <strong id="files-selected-size">0 o</strong></span>
                        </div>

                        <!-- Video Player Modal -->
                        <div id="video-player-modal" class="modal" style="display: none;">
                            <div class="modal-content modal-video">
                                <div class="modal-header">
                                    <h3><i class="fas fa-play-circle"></i> <span id="video-player-title">Lecture</span></h3>
                                    <button type="button" class="modal-close" onclick="closeVideoPlayer()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <video id="video-player" controls autoplay playsinline>
                                        Votre navigateur ne supporte pas la lecture vid?o.
                                    </video>
                                    <div class="video-error" id="video-player-error" style="display: none;">
                                        <i class="fas fa-exclamation-triangle"></i> Erreur de lecture
                                    </div>
                                    <div class="video-info" id="video-info">
                                        <span id="video-duration"></span>
                                        <span id="video-size"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Network Tab -->
                    <div class="tab-content" id="tab-network">
                        <div class="section-header">
                            <h3><i class="fas fa-network-wired"></i> Configuration R?seau</h3>
                            <div class="network-status-bar" id="network-header-status">
                                <span class="status-indicator {{ 'connected' if wifi_info.connected else 'disconnected' }}" id="network-header-indicator">
                                    {{ 'Connect?' if wifi_info.connected else 'D?connect?' }}
                                </span>
                                <span class="wifi-ssid" id="network-header-ssid">{% if wifi_info.connected %}{{ wifi_info.ssid }}{% endif %}</span>
                                <span class="wifi-ip" id="network-header-ip">{% if wifi_info.connected %}{{ wifi_info.ip }}{% endif %}</span>
                            </div>
                        </div>

                        <!-- Interfaces Priority Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-sort-amount-up"></i> Priorit? des Interfaces</h4>
                            <small class="section-help">
                                Glissez-d?posez pour r?organiser la priorit?. L'interface en haut sera utilis?e en premier si disponible.
                            </small>
                            <div id="network-interfaces-list" class="network-interfaces-list">
                                <div class="loading-placeholder">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement des interfaces...
                                </div>
                            </div>
                            <div class="button-group">
                                <button type="button" class="btn btn-secondary" onclick="loadNetworkInterfaces()">
                                    <i class="fas fa-sync"></i> Actualiser
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveInterfacePriority()">
                                    <i class="fas fa-save"></i> Appliquer la priorit?
                                </button>
                            </div>
                        </div>

                        <!-- IP Configuration Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-cog"></i> Configuration IP</h4>
                            <div class="form-group">
                                <label for="network_interface_select">
                                    <i class="fas fa-ethernet"></i> Interface ? configurer
                                </label>
                                <select id="network_interface_select" name="network_interface_select">
                                    <option value="">S?lectionnez une interface...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="network_mode">
                                    <i class="fas fa-sliders-h"></i> Mode IP
                                </label>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="network_mode" value="dhcp" checked onchange="toggleNetworkMode()">
                                        <span class="radio-label"><i class="fas fa-magic"></i> DHCP (Automatique)</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="network_mode" value="static" onchange="toggleNetworkMode()">
                                        <span class="radio-label"><i class="fas fa-edit"></i> IP Statique</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="static-ip-config" class="static-ip-config" style="display: none;">
                                <div class="form-group">
                                    <label for="network_static_ip">
                                        <i class="fas fa-map-marker-alt"></i> Adresse IP
                                    </label>
                                    <input type="text" id="network_static_ip" name="network_static_ip" 
                                           placeholder="192.168.1.100/24" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}\/[0-9]{1,2}$">
                                    <small class="input-help">Format: 192.168.1.100/24</small>
                                </div>
                                <div class="form-group">
                                    <label for="network_gateway">
                                        <i class="fas fa-door-open"></i> Passerelle
                                    </label>
                                    <input type="text" id="network_gateway" name="network_gateway" 
                                           placeholder="192.168.1.1" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$">
                                </div>
                                <div class="form-group">
                                    <label for="network_dns">
                                        <i class="fas fa-globe"></i> DNS
                                    </label>
                                    <input type="text" id="network_dns" name="network_dns" 
                                           placeholder="8.8.8.8, 8.8.4.4">
                                    <small class="input-help">S?parez plusieurs DNS par des virgules</small>
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button type="button" class="btn btn-primary" onclick="applyNetworkConfig()">
                                    <i class="fas fa-check"></i> Appliquer la configuration
                                </button>
                            </div>
                        </div>

                        <!-- Ethernet Priority & WiFi Auto-disable Section -->
                        <div class="form-section ethernet-priority-section">
                            <h4><i class="fas fa-ethernet"></i> Priorit? Ethernet / WiFi</h4>
                            <small class="section-help">
                                <i class="fas fa-info-circle"></i> 
                                Si activ?, le WiFi sur wlan0 sera automatiquement d?sactiv? quand Ethernet est connect?, 
                                sauf si vous forcez manuellement l'activation du WiFi.
                            </small>
                            
                            <div class="ethernet-wifi-status" id="ethernet-wifi-status">
                                <div class="status-grid-small">
                                    <div class="status-item">
                                        <i class="fas fa-ethernet"></i>
                                        <span>Ethernet (eth0):</span>
                                        <span id="eth-status-badge" class="badge badge-warning">V?rification...</span>
                                    </div>
                                    <div class="status-item">
                                        <i class="fas fa-wifi"></i>
                                        <span>WiFi (wlan0):</span>
                                        <span id="wlan0-status-badge" class="badge badge-warning">V?rification...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <i class="fas fa-hand-paper"></i> Forcer WiFi actif (ignorer Ethernet)
                                </label>
                                <div class="toggle-control">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="wifi_manual_override">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span id="wifi-override-status" class="control-status">Auto</span>
                                </div>
                                <small>Quand activ?, WiFi reste actif m?me si Ethernet est connect?</small>
                            </div>
                            
                            <div class="button-group">
                                <button type="button" class="btn btn-primary" onclick="applyWifiOverride()">
                                    <i class="fas fa-check"></i> Appliquer
                                </button>
                            </div>
                        </div>

                        <!-- Access Point Mode Section -->
                        <div class="form-section access-point-section">
                            <h4><i class="fas fa-broadcast-tower"></i> Mode Point d'Acc?s (AP)</h4>
                            <small class="section-help">
                                <i class="fas fa-info-circle"></i> 
                                Transforme wlan0 en point d'acc?s WiFi pour permettre la connexion directe depuis un smartphone/PC.
                                <strong>Les param?tres sont g?r?s par Meeting.</strong>
                            </small>
                            
                            <!-- AP Status Banner -->
                            <div class="ap-status-banner" id="ap-status-banner">
                                <div class="ap-status-content">
                                    <i class="fas fa-circle" id="ap-status-icon"></i>
                                    <span id="ap-status-text">V?rification...</span>
                                    <span id="ap-clients-count" class="badge badge-info" style="display: none;">0 clients</span>
                                </div>
                            </div>
                            
                            <!-- AP Warning Alert -->
                            <div class="alert alert-warning ap-warning" id="ap-warning-alert" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Attention:</strong> Le mode Access Point utilise wlan0, ce qui d?sactive le failover hardware WiFi.
                                    Cependant, wlan1 (dongle USB) reste disponible pour le failover r?seau vers un autre WiFi.
                                </div>
                            </div>
                            
                            <!-- AP Configuration (from Meeting) -->
                            <div class="ap-meeting-info">
                                <div class="info-banner">
                                    <i class="fab fa-meetup"></i>
                                    <span>Param?tres configur?s via Meeting</span>
                                    <button type="button" class="btn btn-small btn-secondary" onclick="loadApConfigFromMeeting()">
                                        <i class="fas fa-sync"></i> Actualiser
                                    </button>
                                </div>
                            </div>
                            
                            <div class="ap-config-display">
                                <div class="ap-param">
                                    <label><i class="fas fa-wifi"></i> Nom du r?seau (SSID)</label>
                                    <input type="text" id="ap_ssid" name="ap_ssid" class="input-locked" readonly 
                                           value="{{ ap_mode.get('ssid', '') or '(non configur? dans Meeting)' }}"
                                           placeholder="(non configur? dans Meeting)">
                                </div>
                                <div class="ap-param">
                                    <label><i class="fas fa-key"></i> Mot de passe WiFi</label>
                                    <input type="text" id="ap_password" name="ap_password" class="input-locked ap-password-visible" readonly
                                           value="{{ ap_mode.get('password', '') or '(non configur? dans Meeting)' }}"
                                           placeholder="(non configur? dans Meeting)">
                                </div>
                                <div class="ap-param">
                                    <label><i class="fas fa-signal"></i> Canal WiFi</label>
                                    <input type="text" id="ap_channel_display" value="Canal {{ ap_mode.get('channel', 11) }} (2462 MHz)" class="input-locked" readonly>
                                    <input type="hidden" id="ap_channel" value="{{ ap_mode.get('channel', 11) }}">
                                </div>
                                <div class="ap-param">
                                    <label><i class="fas fa-map-marker-alt"></i> IP du Point d'Acc?s</label>
                                    <input type="text" id="ap_ip" name="ap_ip" value="192.168.4.1" class="input-locked" readonly>
                                </div>
                            </div>
                            
                            <!-- AP Actions -->
                            <div class="button-group ap-actions">
                                <button type="button" class="btn btn-success" id="btn-start-ap" onclick="startAccessPoint()">
                                    <i class="fas fa-play"></i> D?marrer le Point d'Acc?s
                                </button>
                                <button type="button" class="btn btn-danger" id="btn-stop-ap" onclick="stopAccessPoint()" style="display: none;">
                                    <i class="fas fa-stop"></i> Arr?ter le Point d'Acc?s
                                </button>
                            </div>
                        </div>

                        <!-- Simple WiFi Configuration (shown if only 1 WiFi adapter) -->
                        <div class="form-section wifi-simple-section" id="wifi-simple-section" style="display: none;">
                            <h4><i class="fas fa-wifi"></i> Configuration WiFi</h4>
                            <small class="section-help">
                                <i class="fas fa-info-circle"></i> 
                                Configurez la connexion WiFi de votre appareil.
                            </small>
                            
                            <!-- Current WiFi Status -->
                            <div class="wifi-simple-status" id="wifi-simple-status">
                                <div class="wifi-status-loading">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                                </div>
                            </div>
                            
                            <!-- WiFi Network Config -->
                            <div class="network-config-box primary-network">
                                <div class="network-label">
                                    <i class="fas fa-wifi"></i> R?seau WiFi
                                </div>
                                <div class="form-group">
                                    <label for="wifi_simple_ssid">
                                        <i class="fas fa-broadcast-tower"></i> SSID (Nom du r?seau)
                                    </label>
                                    <div class="input-with-button">
                                        <input type="text" id="wifi_simple_ssid" name="wifi_simple_ssid" 
                                               placeholder="Nom du r?seau WiFi">
                                        <button type="button" class="btn btn-secondary btn-small" 
                                                onclick="scanWifiForField('wifi_simple_ssid')">
                                            <i class="fas fa-search"></i> Scanner
                                        </button>
                                    </div>
                                    <div id="wifi-simple-ssid-list" class="wifi-detection-list"></div>
                                </div>
                                <div class="form-group">
                                    <label for="wifi_simple_password">
                                        <i class="fas fa-key"></i> Mot de passe
                                    </label>
                                    <div class="input-with-button">
                                        <input type="password" id="wifi_simple_password" name="wifi_simple_password" 
                                               placeholder="???????? (inchang? si vide)">
                                        <button type="button" class="btn btn-icon" 
                                                onclick="togglePassword('wifi_simple_password')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- IP Configuration -->
                            <div class="failover-subsection">
                                <h5><i class="fas fa-network-wired"></i> Configuration IP</h5>
                                <div class="form-group">
                                    <div class="radio-group">
                                        <label class="radio-option">
                                            <input type="radio" name="wifi_simple_ip_mode" value="dhcp" checked 
                                                   onchange="toggleWifiSimpleIpMode()">
                                            <span class="radio-label"><i class="fas fa-magic"></i> DHCP (Automatique)</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="wifi_simple_ip_mode" value="static" 
                                                   onchange="toggleWifiSimpleIpMode()">
                                            <span class="radio-label"><i class="fas fa-edit"></i> IP Statique</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="wifi-simple-static-config" class="static-ip-config" style="display: none;">
                                    <div class="form-group">
                                        <label for="wifi_simple_static_ip">
                                            <i class="fas fa-map-marker-alt"></i> Adresse IP
                                        </label>
                                        <input type="text" id="wifi_simple_static_ip" 
                                               placeholder="192.168.1.100/24">
                                        <small>Format: 192.168.1.100/24</small>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="wifi_simple_gateway">
                                                <i class="fas fa-door-open"></i> Passerelle
                                            </label>
                                            <input type="text" id="wifi_simple_gateway" 
                                                   placeholder="192.168.1.1">
                                        </div>
                                        <div class="form-group">
                                            <label for="wifi_simple_dns">
                                                <i class="fas fa-globe"></i> DNS
                                            </label>
                                            <input type="text" id="wifi_simple_dns" 
                                                   placeholder="8.8.8.8" value="8.8.8.8">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="button-group">
                                <button type="button" class="btn btn-secondary" onclick="loadWifiSimpleStatus()">
                                    <i class="fas fa-sync"></i> Actualiser
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveWifiSimpleConfig()">
                                    <i class="fas fa-save"></i> Enregistrer
                                </button>
                                <button type="button" class="btn btn-success" onclick="connectWifiSimple()">
                                    <i class="fas fa-plug"></i> Connecter
                                </button>
                            </div>
                        </div>

                        <!-- WiFi Failover Section (hidden if < 2 WiFi adapters) -->
                        <div class="form-section wifi-failover-section" id="wifi-failover-section" style="display: none;">
                            <h4><i class="fas fa-wifi"></i> Configuration WiFi avec Failover</h4>
                            <small class="section-help">
                                <i class="fas fa-info-circle"></i> 
                                Deux niveaux de failover : <strong>Hardware</strong> (si le dongle USB est retir? ? utiliser WiFi int?gr?) 
                                et <strong>R?seau</strong> (si le point d'acc?s principal est indisponible ? utiliser r?seau de secours).
                            </small>
                            
                            <!-- WiFi Status Banner -->
                            <div class="wifi-failover-status" id="wifi-failover-status">
                                <div class="wifi-status-loading">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                                </div>
                            </div>
                            
                            <!-- WiFi Interfaces Status -->
                            <div class="wifi-interfaces-grid" id="wifi-interfaces-grid">
                                <!-- Filled by JS -->
                            </div>
                            
                            <!-- === HARDWARE FAILOVER === -->
                            <div class="failover-subsection">
                                <h5><i class="fas fa-microchip"></i> Failover Hardware (Interface)</h5>
                                <small class="subsection-help">
                                    Bascule automatique entre les dongles WiFi physiques. 
                                    Le dongle principal est utilis? si pr?sent, sinon le secondaire prend le relai.
                                </small>
                                
                                <div class="form-group">
                                    <label>
                                        <i class="fas fa-toggle-on"></i> Activer le failover hardware
                                    </label>
                                    <div class="toggle-control">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="wifi_hardware_failover_enabled" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span id="wifi-hw-failover-status" class="control-status">Activ?</span>
                                    </div>
                                    <small>Si d?sactiv?, seule l'interface principale sera utilis?e</small>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="wifi_primary_interface">
                                            <i class="fas fa-star"></i> Interface Principale
                                        </label>
                                        <select id="wifi_primary_interface" name="wifi_primary_interface">
                                            <option value="wlan1">wlan1 (USB Dongle)</option>
                                            <option value="wlan0">wlan0 (Built-in)</option>
                                        </select>
                                        <small>Utilis?e en priorit? si physiquement pr?sente</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="wifi_secondary_interface">
                                            <i class="fas fa-life-ring"></i> Interface Secondaire
                                        </label>
                                        <select id="wifi_secondary_interface" name="wifi_secondary_interface">
                                            <option value="wlan0">wlan0 (Built-in)</option>
                                            <option value="wlan1">wlan1 (USB Dongle)</option>
                                        </select>
                                        <small>Fallback si la principale est absente</small>
                                    </div>
                                </div>
                                
                                <div class="subsection-actions">
                                    <button type="button" class="btn btn-primary btn-small" onclick="applyHardwareFailover()">
                                        <i class="fas fa-check"></i> Appliquer
                                    </button>
                                </div>
                            </div>
                            
                            <!-- === NETWORK FAILOVER === -->
                            <div class="failover-subsection">
                                <h5><i class="fas fa-broadcast-tower"></i> Failover R?seau (SSID)</h5>
                                <small class="subsection-help">
                                    Bascule automatique entre deux r?seaux WiFi. 
                                    Le r?seau principal est utilis? si disponible, sinon le secondaire.
                                </small>
                                
                                <div class="form-group">
                                    <label>
                                        <i class="fas fa-toggle-on"></i> Activer le failover r?seau
                                    </label>
                                    <div class="toggle-control">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="wifi_network_failover_enabled" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span id="wifi-net-failover-status" class="control-status">Activ?</span>
                                    </div>
                                    <small>Si d?sactiv?, seul le r?seau principal sera utilis?</small>
                                </div>
                                
                                <!-- Primary Network -->
                                <div class="network-config-box primary-network">
                                    <div class="network-label">
                                        <i class="fas fa-star"></i> R?seau Principal
                                    </div>
                                    <div class="form-group">
                                        <label for="wifi_primary_ssid">
                                            <i class="fas fa-wifi"></i> SSID
                                        </label>
                                        <div class="input-with-button">
                                            <input type="text" id="wifi_primary_ssid" name="wifi_primary_ssid" 
                                                   placeholder="Nom du r?seau WiFi principal">
                                            <button type="button" class="btn btn-secondary btn-small" 
                                                    onclick="scanWifiForField('wifi_primary_ssid')">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                        <div id="wifi-primary-ssid-list" class="wifi-detection-list"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="wifi_primary_password">
                                            <i class="fas fa-key"></i> Mot de passe
                                        </label>
                                        <div class="input-with-button">
                                            <input type="password" id="wifi_primary_password" name="wifi_primary_password" 
                                                   placeholder="???????? (inchang? si vide)">
                                            <button type="button" class="btn btn-icon" 
                                                    onclick="togglePassword('wifi_primary_password')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Secondary Network -->
                                <div class="network-config-box secondary-network">
                                    <div class="network-label">
                                        <i class="fas fa-life-ring"></i> R?seau Secondaire
                                    </div>
                                    <div class="form-group">
                                        <label for="wifi_secondary_ssid">
                                            <i class="fas fa-wifi"></i> SSID
                                        </label>
                                        <div class="input-with-button">
                                            <input type="text" id="wifi_secondary_ssid" name="wifi_secondary_ssid" 
                                                   placeholder="Nom du r?seau WiFi de secours">
                                            <button type="button" class="btn btn-secondary btn-small" 
                                                    onclick="scanWifiForField('wifi_secondary_ssid')">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                        <div id="wifi-secondary-ssid-list" class="wifi-detection-list"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="wifi_secondary_password">
                                            <i class="fas fa-key"></i> Mot de passe
                                        </label>
                                        <div class="input-with-button">
                                            <input type="password" id="wifi_secondary_password" name="wifi_secondary_password" 
                                                   placeholder="???????? (inchang? si vide)">
                                            <button type="button" class="btn btn-icon" 
                                                    onclick="togglePassword('wifi_secondary_password')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="subsection-actions">
                                    <button type="button" class="btn btn-primary btn-small" onclick="applyNetworkFailover()">
                                        <i class="fas fa-check"></i> Appliquer
                                    </button>
                                </div>
                            </div>
                            
                            <!-- === IP CONFIGURATION === -->
                            <div class="failover-subsection">
                                <h5><i class="fas fa-network-wired"></i> Configuration IP (Partag?e)</h5>
                                <small class="subsection-help">
                                    Cette configuration IP sera appliqu?e quelle que soit l'interface ou le r?seau actif.
                                </small>
                                
                                <div class="form-group">
                                    <div class="radio-group">
                                        <label class="radio-option">
                                            <input type="radio" name="wifi_failover_ip_mode" value="dhcp" checked 
                                                   onchange="toggleWifiFailoverIpMode()">
                                            <span class="radio-label"><i class="fas fa-magic"></i> DHCP (Automatique)</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="wifi_failover_ip_mode" value="static" 
                                                   onchange="toggleWifiFailoverIpMode()">
                                            <span class="radio-label"><i class="fas fa-edit"></i> IP Statique</span>
                                        </label>
                                    </div>
                                </div>
                                
                                  <div id="wifi-failover-static-config" class="static-ip-config" style="display: none;">
                                      <div class="form-group">
                                          <label for="wifi_failover_static_ip">
                                              <i class="fas fa-map-marker-alt"></i> Adresse IP
                                          </label>
                                          <input type="text" id="wifi_failover_static_ip" 
                                                 placeholder="192.168.1.100/24">
                                          <small>Format: 192.168.1.100/24</small>
                                      </div>
                                      <div class="form-row">
                                          <div class="form-group">
                                              <label for="wifi_failover_gateway">
                                                  <i class="fas fa-door-open"></i> Passerelle
                                              </label>
                                              <input type="text" id="wifi_failover_gateway" 
                                                     placeholder="192.168.1.1">
                                          </div>
                                          <div class="form-group">
                                              <label for="wifi_failover_dns">
                                                  <i class="fas fa-globe"></i> DNS
                                              </label>
                                              <input type="text" id="wifi_failover_dns" 
                                                     placeholder="8.8.8.8" value="8.8.8.8">
                                          </div>
                                      </div>
                                  </div>
                                  <div class="form-group">
                                      <label for="wifi_failover_check_interval">
                                          <i class="fas fa-stopwatch"></i> Intervalle de v?rification (s)
                                      </label>
                                      <input type="number" id="wifi_failover_check_interval" min="5" max="300" value="30">
                                      <small>Fr?quence de v?rification du failover hardware/r?seau</small>
                                  </div>
                                  
                                  <div class="subsection-actions">
                                      <button type="button" class="btn btn-primary btn-small" onclick="applyIpConfig()">
                                          <i class="fas fa-check"></i> Appliquer
                                      </button>
                                </div>
                            </div>
                            
                            <!-- Actions globales -->
                            <div class="button-group wifi-failover-actions">
                                <button type="button" class="btn btn-secondary" onclick="loadWifiFailoverStatus()">
                                    <i class="fas fa-sync"></i> Actualiser
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveWifiFailoverConfig()">
                                    <i class="fas fa-save"></i> Tout enregistrer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- System Tab (LEDs & GPU) -->
                    <div class="tab-content" id="tab-system">
                        <!-- Platform Info Banner -->
                        <div class="platform-info">
                            <i class="fas fa-microchip"></i>
                            <span>Plateforme: <strong>{{ platform.model }}</strong></span>
                            {% if system_info.os_name %}
                            <span class="os-name">{{ system_info.os_name }}</span>
                            {% endif %}
                        </div>

                        <!-- Combined Power & LED Management Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-bolt"></i> Gestion ?nerg?tique & LEDs</h4>
                            <small class="section-help">
                                ?conomisez de l'?nergie en d?sactivant les composants non utilis?s. Les modifications seront persistantes au red?marrage.
                            </small>
                            
                            <div class="energy-status-box" id="energy-status">
                                <div class="energy-estimate">
                                    <i class="fas fa-calculator"></i>
                                    <span>?conomies estim?es: <strong id="estimated-savings-ma">0 mA</strong></span>
                                </div>
                            </div>
                            
                            <div class="power-controls">
                                <!-- LEDs Section Header -->
                                <div class="power-section-header">
                                    <i class="fas fa-lightbulb"></i> LEDs
                                </div>

                                <!-- PWR LED -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="led-icon pwr {{ 'on' if led_status.pwr.enabled else 'off' }}">
                                            <i class="fas fa-circle"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>LED Power (Rouge)</strong>
                                            <small id="led-pwr-status">Indique que le Pi est aliment?</small>
                                            <span class="badge badge-info">?conomie: ~5 mA</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="led_pwr" name="led_pwr" 
                                                   {{ 'checked' if led_status.pwr.enabled else '' }}
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- ACT LED -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="led-icon act {{ 'on' if led_status.act.enabled else 'off' }}">
                                            <i class="fas fa-circle"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>LED Activity (Verte)</strong>
                                            <small id="led-act-status">Clignote lors d'acc?s SD/activit?</small>
                                            <span class="badge badge-info">?conomie: ~3 mA</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="led_act" name="led_act" 
                                                   {{ 'checked' if led_status.act.enabled else '' }}
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Camera LED (CSI) -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="led-icon camera">
                                            <i class="fas fa-video"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>LED Cam?ra CSI</strong>
                                            <small id="led-camera-csi-status">LED rouge du module Pi Camera</small>
                                            <span class="badge badge-info">?conomie: ~2 mA</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="led_camera_csi" name="led_camera_csi"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Camera LED (USB) -->
                                <div class="power-control-item" id="usb-camera-led-control" style="display: none;">
                                    <div class="power-info">
                                        <span class="led-icon camera-usb">
                                            <i class="fas fa-usb"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>LED Cam?ra USB</strong>
                                            <small id="led-camera-usb-status">LED d'activit? webcam (si support?)</small>
                                            <span class="badge badge-warning">Selon mod?le</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="led_camera_usb" name="led_camera_usb"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Ethernet LED -->
                                <div class="power-control-item" id="eth-led-control">
                                    <div class="power-info">
                                        <span class="led-icon eth {{ 'on' if led_status.eth.enabled else 'off' if led_status.eth.available else 'na' }}">
                                            <i class="fas fa-ethernet"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>LED Ethernet</strong>
                                            <small id="led-eth-status">
                                                {% if led_status.eth.available %}
                                                LEDs Link/Activity du port RJ45
                                                {% else %}
                                                Non contr?lable sur {{ platform.model }} (LEDs g?r?es par PHY)
                                                {% endif %}
                                            </small>
                                            {% if led_status.eth.available %}
                                            <span class="badge badge-info">?conomie: ~5 mA</span>
                                            {% else %}
                                            <span class="badge badge-secondary">Non support?</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        {% if led_status.eth.available %}
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="led_eth" name="led_eth"
                                                   {{ 'checked' if led_status.eth.enabled else '' }}
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        {% else %}
                                        <span class="toggle-unavailable" title="Non contr?lable sur ce mod?le">
                                            <i class="fas fa-ban"></i>
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Components Section Header -->
                                <div class="power-section-header">
                                    <i class="fas fa-microchip"></i> Composants
                                </div>

                                <!-- Bluetooth Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon bt">
                                            <i class="fas fa-bluetooth"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>Bluetooth</strong>
                                            <small id="bt-status">?tat: Chargement...</small>
                                            <span class="badge badge-info">?conomie: ~20 mA</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="power_bt" name="power_bt" 
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- WiFi Integrated Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon wifi">
                                            <i class="fas fa-wifi"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>WiFi Int?gr? (wlan0)</strong>
                                            <small id="wifi-integrated-status">?tat: Chargement...</small>
                                            <span class="badge badge-info">?conomie: ~40 mA</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="power_wifi" name="power_wifi"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- HDMI Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon hdmi">
                                            <i class="fas fa-display"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>HDMI</strong>
                                            <small id="hdmi-status">?tat: Chargement...</small>
                                            <span class="badge badge-info">?conomie: ~40 mA</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="power_hdmi" name="power_hdmi"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Audio Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon audio">
                                            <i class="fas fa-volume-mute"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>Audio</strong>
                                            <small id="audio-status">?tat: Chargement...</small>
                                            <span class="badge badge-info">?conomie: ~10 mA</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="power_audio" name="power_audio"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Services Section Header -->
                                <div class="power-section-header">
                                    <i class="fas fa-cogs"></i> Services Linux
                                </div>

                                <!-- ModemManager Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon service">
                                            <i class="fas fa-signal"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>ModemManager</strong>
                                            <small id="modemmanager-status">Gestion modems 3G/4G (inutile sans modem)</small>
                                            <span class="badge badge-info">?conomie: ~15 mA + RAM</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="service_modemmanager" name="service_modemmanager"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Avahi Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon service">
                                            <i class="fas fa-broadcast-tower"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>Avahi (mDNS)</strong>
                                            <small id="avahi-status">D?couverte r?seau Bonjour/Zeroconf</small>
                                            <span class="badge badge-warning">~5 mA (utile ONVIF)</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="service_avahi" name="service_avahi"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Cloud-Init Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon service">
                                            <i class="fas fa-cloud"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>Cloud-Init</strong>
                                            <small id="cloudinit-status">Provisioning cloud (inutile hors cloud)</small>
                                            <span class="badge badge-info">?conomie: RAM + boot rapide</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="service_cloudinit" name="service_cloudinit"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Console S?rie Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon service">
                                            <i class="fas fa-terminal"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>Console S?rie</strong>
                                            <small id="serial-status">Getty sur port s?rie (debug uniquement)</small>
                                            <span class="badge badge-info">?conomie: ~2 mA + s?curit?</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="service_serial" name="service_serial"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- TTY1 Getty Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon service">
                                            <i class="fas fa-desktop"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>Console TTY1</strong>
                                            <small id="tty1-status">Login sur ?cran HDMI (inutile si headless)</small>
                                            <span class="badge badge-info">?conomie: ~2 mA</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="service_tty1" name="service_tty1"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Udisks2 Control -->
                                <div class="power-control-item">
                                    <div class="power-info">
                                        <span class="power-icon service">
                                            <i class="fas fa-usb"></i>
                                        </span>
                                        <div class="power-details">
                                            <strong>UDisks2</strong>
                                            <small id="udisks2-status">Automontage disques USB</small>
                                            <span class="badge badge-warning">~5 mA (utile USB)</span>
                                        </div>
                                    </div>
                                    <div class="power-actions">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="service_udisks2" name="service_udisks2"
                                                   onchange="markPowerSettingsChanged()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="power-info-box" style="margin-top: 15px;">
                                <i class="fas fa-info-circle"></i>
                                <span><strong>Note:</strong> Les changements seront effectifs au prochain red?marrage du syst?me.</span>
                            </div>

                            <div class="power-apply-section" style="margin-top: 20px;">
                                <button type="button" class="btn btn-primary" id="btn-apply-power" onclick="applyPowerSettings()" disabled>
                                    <i class="fas fa-save"></i> Appliquer (red?marrage requis)
                                </button>
                                <span id="power-changes-indicator" class="changes-indicator" style="display: none;">
                                    <i class="fas fa-exclamation-circle"></i> Modifications non enregistr?es
                                </span>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4><i class="fas fa-memory"></i> M?moire GPU</h4>
                            <small class="section-help">Allocation de m?moire pour le GPU. Plus de m?moire GPU = meilleures performances vid?o mais moins de RAM disponible.</small>
                            
                            <div class="form-group">
                                <label for="gpu_mem">
                                    <i class="fas fa-microchip"></i> M?moire GPU (Mo)
                                </label>
                                <select id="gpu_mem" name="gpu_mem">
                                    <option value="64" {{ 'selected' if gpu_mem.current == 64 }}>64 Mo (minimum)</option>
                                    <option value="128" {{ 'selected' if gpu_mem.current == 128 }}>128 Mo (d?faut)</option>
                                    <option value="192" {{ 'selected' if gpu_mem.current == 192 }}>192 Mo</option>
                                    <option value="256" {{ 'selected' if gpu_mem.current == 256 }}>256 Mo (recommand? vid?o)</option>
                                    <option value="320" {{ 'selected' if gpu_mem.current == 320 }}>320 Mo</option>
                                    <option value="384" {{ 'selected' if gpu_mem.current == 384 }}>384 Mo</option>
                                    <option value="448" {{ 'selected' if gpu_mem.current == 448 }}>448 Mo</option>
                                    <option value="512" {{ 'selected' if gpu_mem.current == 512 }}>512 Mo (maximum Pi 3B+)</option>
                                </select>
                                <small>Valeur actuelle: <strong id="current-gpu-mem">{{ gpu_mem.current }} Mo</strong> (recommand?: {{ gpu_mem.recommended }} Mo)</small>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="setGpuMem()">
                                <i class="fas fa-save"></i> Appliquer (red?marrage requis)
                            </button>
                        </div>

                        <!-- NTP Configuration -->
                        <div class="form-section">
                            <h4><i class="fas fa-clock"></i> Synchronisation horaire (NTP)</h4>
                            <small class="section-help">Configurez le serveur NTP pour synchroniser l'heure du syst?me.</small>
                            
                            <div class="ntp-status" id="ntp-status">
                                <div class="status-indicator">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="ntp_server">
                                    <i class="fas fa-server"></i> Serveur NTP
                                </label>
                                <div class="input-with-button">
                                    <input type="text" id="ntp_server" name="ntp_server" 
                                           placeholder="pool.ntp.org">
                                    <button type="button" class="btn btn-secondary btn-small" onclick="loadNtpConfig()">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                                <small>Exemples: pool.ntp.org, time.google.com, fr.pool.ntp.org</small>
                            </div>

                            <div class="form-group">
                                <label for="rtc_mode">
                                    <i class="fas fa-stopwatch"></i> Horloge mat?rielle (RTC DS3231)
                                </label>
                                <select id="rtc_mode" name="rtc_mode">
                                    <option value="auto">Auto (activer si d?tect?)</option>
                                    <option value="enabled">Forcer activation</option>
                                    <option value="disabled">D?sactiver</option>
                                </select>
                                <small>Utilise l'horloge RTC pour conserver l'heure sans r?seau.</small>
                            </div>

                            <div class="rtc-status" id="rtc-status">
                                <div class="status-indicator">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                                </div>
                            </div>
                            <div class="button-group">
                                <button type="button" class="btn btn-primary" onclick="saveNtpConfig()">
                                    <i class="fas fa-save"></i> Appliquer
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="syncNtpNow()">
                                    <i class="fas fa-sync"></i> Synchroniser maintenant
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="loadRtcConfig()">
                                    <i class="fas fa-sync"></i> Rafra?chir RTC
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveRtcConfig()">
                                    <i class="fas fa-save"></i> Appliquer RTC
                                </button>
                            </div>
                        </div>

                        <!-- Scheduled Reboot -->
                        <div class="form-section scheduled-reboot">
                            <h4><i class="fas fa-redo-alt"></i> Red?marrage planifi?</h4>
                            <small class="section-help">Planifiez un red?marrage automatique selon un horaire.</small>

                            <div class="reboot-toggle-row">
                                <label class="toggle-label">
                                    <span><i class="fas fa-toggle-on"></i> Activer</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="reboot_schedule_enabled" onchange="updateRebootScheduleUiState()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reboot_schedule_hour"><i class="fas fa-clock"></i> Heure</label>
                                    <select id="reboot_schedule_hour"></select>
                                </div>
                                <div class="form-group">
                                    <label for="reboot_schedule_minute"><i class="fas fa-clock"></i> Minute</label>
                                    <select id="reboot_schedule_minute"></select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-calendar-alt"></i> Jours</label>
                                <div class="reboot-days-grid" id="reboot-schedule-days">
                                    <label class="reboot-day"><input type="checkbox" value="all"> Tous les jours</label>
                                    <label class="reboot-day"><input type="checkbox" value="1"> Lundi</label>
                                    <label class="reboot-day"><input type="checkbox" value="2"> Mardi</label>
                                    <label class="reboot-day"><input type="checkbox" value="3"> Mercredi</label>
                                    <label class="reboot-day"><input type="checkbox" value="4"> Jeudi</label>
                                    <label class="reboot-day"><input type="checkbox" value="5"> Vendredi</label>
                                    <label class="reboot-day"><input type="checkbox" value="6"> Samedi</label>
                                    <label class="reboot-day"><input type="checkbox" value="0"> Dimanche</label>
                                </div>
                            </div>

                            <div class="button-group">
                                <button type="button" class="btn btn-secondary" onclick="loadRebootSchedule()">
                                    <i class="fas fa-sync"></i> Recharger
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveRebootSchedule()">
                                    <i class="fas fa-save"></i> Appliquer
                                </button>
                            </div>
                        </div>

                        <!-- SNMP Configuration -->
                        <div class="form-section">
                            <h4><i class="fas fa-network-wired"></i> Monitoring (SNMP)</h4>
                            <small class="section-help">Configuration du serveur SNMP (destination). Optionnel.</small>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="toggle-label">
                                        <span><i class="fas fa-toggle-on"></i> Activer SNMP</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="snmp_enabled" onchange="updateSnmpUiState()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </label>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="snmp_host">
                                        <i class="fas fa-server"></i> Serveur SNMP (host / IP)
                                    </label>
                                    <input type="text" id="snmp_host" name="snmp_host" placeholder="192.168.1.10 ou snmp.local">
                                </div>
                                <div class="form-group">
                                    <label for="snmp_port">
                                        <i class="fas fa-plug"></i> Port
                                    </label>
                                    <input type="number" id="snmp_port" name="snmp_port" min="1" max="65535" placeholder="162">
                                </div>
                            </div>

                            <div class="button-group">
                                <button type="button" class="btn btn-secondary" onclick="loadSnmpConfig()">
                                    <i class="fas fa-sync"></i> Recharger
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="testSnmpConfig()">
                                    <i class="fas fa-check"></i> Tester
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveSnmpConfig()">
                                    <i class="fas fa-save"></i> Appliquer
                                </button>
                            </div>
                        </div>

                        <!-- Repo Updater -->
                        <div class="form-section">
                            <h4><i class="fab fa-github"></i> Update depuis repo</h4>
                            <small class="section-help">Mettez a jour le systeme depuis le repo GitHub.</small>
                            
                            <div class="update-status" id="update-status">
                                <div class="current-version">
                                    <span class="label">Version actuelle:</span>
                                    <span class="version" id="current-version">v{{ app_version }}</span>
                                </div>
                                <div class="latest-version">
                                    <span class="label">Derni?re version:</span>
                                    <span class="version" id="latest-version">
                                        <i class="fas fa-spinner fa-spin"></i> V?rification...
                                    </span>
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button type="button" class="btn btn-secondary" onclick="checkUpdateRepo()">
                                    <i class="fas fa-search"></i> V?rifier les mises ? jour
                                </button>
                                <button type="button" class="btn btn-primary" id="btn-update" onclick="openUpdateRepoModal()">
                                    <i class="fas fa-download"></i> Update depuis repo
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="openUpdateFilePicker()">
                                    <i class="fas fa-file-upload"></i> Update depuis fichier
                                </button>
                            </div>
                            <input type="file" id="update-file-input"
                                   accept=".tar,.tar.gz,.tgz,.gz"
                                   style="display: none;"
                                   onchange="handleUpdateFileSelected(event)">
                        </div>

                        <!-- Backup / Restore -->
                        <div class="form-section">
                            <h4><i class="fas fa-archive"></i> Backup / Restore</h4>
                            <small class="section-help">
                                Sauvegarde et restauration de la configuration locale (logs optionnels).
                            </small>
                            
                            <div class="debug-action-status" id="backup-status">
                                <span class="status-label">Statut:</span>
                                <span class="status-value" id="backup-status-text">En attente</span>
                            </div>
                            
                            <div class="button-group">
                                <button type="button" class="btn btn-secondary" onclick="backupConfiguration()">
                                    <i class="fas fa-download"></i> Backup configuration
                                </button>
                                <button type="button" class="btn btn-primary" onclick="openBackupFilePicker('restore')">
                                    <i class="fas fa-upload"></i> Restore configuration
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="openBackupFilePicker('check')">
                                    <i class="fas fa-check-circle"></i> Check backup
                                </button>
                            </div>
                            
                            <input type="file" id="backup-file-input"
                                   accept=".tar,.tar.gz,.tgz,.gz"
                                   style="display: none;"
                                   onchange="handleBackupFileSelected(event)">
                        </div>

                        <div class="form-section danger-zone">
                            <h4><i class="fas fa-exclamation-triangle"></i> Actions Syst?me</h4>
                            <button type="button" class="btn btn-danger" onclick="confirmReboot()">
                                <i class="fas fa-redo"></i> Red?marrer le Raspberry Pi
                            </button>
                        </div>
                    </div>

                    <!-- Meeting Tab -->
                    <div class="tab-content" id="tab-meeting">
                        <div class="platform-info" style="margin-bottom: 20px;">
                            <i class="fas fa-cloud"></i>
                            <span>Int?gration <strong>Meeting API</strong> - Gestion IoT centralis?e</span>
                        </div>

                        <!-- Provisioning Status Banner -->
                        <div id="meeting-provisioned-banner" class="provisioned-banner" style="display: none;">
                            <div class="banner-content">
                                <i class="fas fa-lock"></i>
                                <div class="banner-text">
                                    <strong>Device provisionn?</strong>
                                    <span id="provisioned-device-key"></span>
                                </div>
                            </div>
                            <button type="button" class="btn btn-danger btn-small" onclick="showMasterResetModal()">
                                <i class="fas fa-unlock-alt"></i> Master Reset
                            </button>
                        </div>

                        <!-- Connection Status -->
                        <div class="form-section">
                            <h4><i class="fas fa-plug"></i> ?tat de la connexion</h4>
                            <div class="meeting-status" id="meeting-status">
                                <div class="status-card">
                                    <span class="status-indicator disconnected" id="meeting-connection-status">
                                        <i class="fas fa-circle"></i> Non configur?
                                    </span>
                                    <div class="status-details" id="meeting-status-details">
                                        <small>Configurez les param?tres ci-dessous pour activer l'int?gration</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Provisioning Section (shown when not provisioned) -->
                        <div id="meeting-provisioning-section">
                            <div class="form-section">
                                <h4><i class="fas fa-rocket"></i> Provisioning du device</h4>
                                <p class="section-help">Entrez vos credentials Meeting pour provisionner ce device. Cette op?ration consomme un token et verrouille la configuration.</p>
                                
                                <div class="form-group">
                                    <label for="provision_api_url">
                                        <i class="fas fa-globe"></i> URL de l'API Meeting
                                    </label>
                                    <input type="text" id="provision_api_url" 
                                           value="https://meeting.ygsoft.fr/api"
                                           readonly
                                           class="input-locked"
                                           title="URL fix?e par d?faut - non modifiable">
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="provision_device_key">
                                            <i class="fas fa-key"></i> Device Key
                                        </label>
                                        <input type="text" id="provision_device_key" 
                                               value="{{ config.MEETING_DEVICE_KEY }}"
                                               placeholder="ABCDEF123456789..."
                                               style="font-family: monospace; text-transform: uppercase;">
                                        <small>Cl? unique du device (32 caract?res)</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="provision_token_code">
                                            <i class="fas fa-ticket-alt"></i> Token Code
                                        </label>
                                        <div class="input-with-button">
                                            <input type="password" id="provision_token_code" 
                                                   value="{{ config.MEETING_TOKEN_CODE }}"
                                                   placeholder="token_secret"
                                                   style="font-family: monospace;">
                                            <button type="button" class="btn btn-icon" onclick="togglePassword('provision_token_code')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <small>Code d'authentification</small>
                                    </div>
                                </div>

                                <div class="provision-actions" style="margin-top: 20px;">
                                    <button type="button" class="btn btn-primary btn-large" onclick="validateMeetingCredentials()">
                                        <i class="fas fa-check-circle"></i> Valider les credentials
                                    </button>
                                    <button type="button" class="btn btn-success btn-large" id="btn-provision" onclick="provisionDevice()" disabled>
                                        <i class="fas fa-rocket"></i> Provisionner le device
                                    </button>
                                </div>
                                
                                <div id="provision-validation-result" class="meeting-result" style="display: none; margin-top: 15px;"></div>
                            </div>
                        </div>

                        <!-- Provisioned Configuration (shown when provisioned, read-only) -->
                        <div id="meeting-provisioned-config" style="display: none;">
                            <div class="form-section">
                                <h4><i class="fas fa-cog"></i> Configuration Meeting (verrouill?e)</h4>
                                
                                <div class="form-group">
                                    <label><i class="fas fa-globe"></i> URL de l'API</label>
                                    <input type="text" id="MEETING_API_URL" name="MEETING_API_URL" 
                                           value="{{ config.MEETING_API_URL }}" readonly
                                           class="input-locked">
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label><i class="fas fa-key"></i> Device Key</label>
                                        <input type="text" id="MEETING_DEVICE_KEY" name="MEETING_DEVICE_KEY" 
                                               value="{{ config.MEETING_DEVICE_KEY }}" readonly
                                               class="input-locked" style="font-family: monospace;">
                                    </div>
                                    <div class="form-group">
                                        <label><i class="fas fa-ticket-alt"></i> Token Code</label>
                                        <input type="password" id="MEETING_TOKEN_CODE" name="MEETING_TOKEN_CODE" 
                                               value="********" readonly
                                               class="input-locked" style="font-family: monospace;">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="MEETING_HEARTBEAT_INTERVAL">
                                        <i class="fas fa-heartbeat"></i> Intervalle Heartbeat (secondes)
                                    </label>
                                    <input type="number" id="MEETING_HEARTBEAT_INTERVAL" name="MEETING_HEARTBEAT_INTERVAL" 
                                           value="{{ config.MEETING_HEARTBEAT_INTERVAL }}"
                                           min="10" max="300">
                                    <small>Fr?quence d'envoi du heartbeat ? Meeting (modifiable)</small>
                                </div>
                                
                                <!-- Hidden fields for form submission -->
                                <input type="hidden" name="MEETING_ENABLED" value="yes">
                                <input type="hidden" name="MEETING_PROVISIONED" value="yes">
                            </div>
                        </div>

                        <!-- Test & Actions (shown when provisioned) -->
                        <div id="meeting-actions-section" style="display: none;">
                            <div class="form-section">
                                <h4><i class="fas fa-vial"></i> Actions</h4>
                                <div class="meeting-actions">
                                    <button type="button" class="btn btn-success" onclick="sendMeetingHeartbeat()">
                                        <i class="fas fa-heartbeat"></i> Envoyer un heartbeat
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="getMeetingAvailability()">
                                        <i class="fas fa-info-circle"></i> V?rifier disponibilit?
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="fetchMeetingDeviceInfo()">
                                        <i class="fas fa-sync"></i> Infos device
                                    </button>
                                </div>
                                <div id="meeting-test-result" class="meeting-result" style="display: none; margin-top: 15px;"></div>
                            </div>

                            <!-- Device Info from Meeting -->
                            <div class="form-section">
                                <h4><i class="fas fa-server"></i> Informations du device (Meeting)</h4>
                                <div id="meeting-device-info" class="meeting-info-container">
                                    <p class="text-muted">Cliquez sur "Infos device" pour charger les donn?es depuis Meeting</p>
                                </div>
                            </div>

                            <!-- Tunnel Request -->
                            <div class="form-section">
                                <h4><i class="fas fa-project-diagram"></i> Tunnels (Services distants)</h4>
                                <small class="section-help">Demandez l'ouverture d'un tunnel reverse pour acc?der au device depuis l'ext?rieur</small>
                                
                                <div class="tunnel-controls" style="margin-top: 15px;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Service</label>
                                            <select id="meeting-tunnel-service">
                                                <option value="ssh">SSH</option>
                                                <option value="http">HTTP</option>
                                                <option value="vnc">VNC</option>
                                                <option value="rtsp">RTSP</option>
                                            </select>
                                        </div>
                                        <div class="form-group" style="display: flex; align-items: flex-end;">
                                            <button type="button" class="btn btn-primary" onclick="requestMeetingTunnel()">
                                                <i class="fas fa-external-link-alt"></i> Demander un tunnel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="meeting-tunnel-result" class="meeting-result" style="display: none; margin-top: 15px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Master Reset Modal -->
                    <div id="master-reset-modal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-exclamation-triangle"></i> Master Reset</h3>
                                <button type="button" class="modal-close" onclick="closeMasterResetModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p class="warning-text">
                                    <strong>Attention !</strong> Cette action va r?initialiser la configuration Meeting.<br>
                                    Le hostname du device ne sera pas modifi?.
                                </p>
                                <div class="form-group">
                                    <label for="master_reset_code">
                                        <i class="fas fa-key"></i> Code Master
                                    </label>
                                    <input type="password" id="master_reset_code" placeholder="Entrez le code master">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeMasterResetModal()">Annuler</button>
                                <button type="button" class="btn btn-danger" onclick="executeMasterReset()">
                                    <i class="fas fa-unlock-alt"></i> R?initialiser
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Tab -->
                    <div class="tab-content" id="tab-advanced">
                        <div class="form-group">
                            <label for="GST_DEBUG_LEVEL">
                                <i class="fas fa-bug"></i> Niveau de debug GStreamer
                            </label>
                            <select id="GST_DEBUG_LEVEL" name="GST_DEBUG_LEVEL">
                                <option value="0" {{ 'selected' if config.GST_DEBUG_LEVEL == '0' }}>0 - Aucun</option>
                                <option value="1" {{ 'selected' if config.GST_DEBUG_LEVEL == '1' }}>1 - Erreurs</option>
                                <option value="2" {{ 'selected' if config.GST_DEBUG_LEVEL == '2' }}>2 - Warnings</option>
                                <option value="3" {{ 'selected' if config.GST_DEBUG_LEVEL == '3' }}>3 - Info</option>
                                <option value="4" {{ 'selected' if config.GST_DEBUG_LEVEL == '4' }}>4 - Debug</option>
                                <option value="5" {{ 'selected' if config.GST_DEBUG_LEVEL == '5' }}>5 - Log</option>
                                <option value="6" {{ 'selected' if config.GST_DEBUG_LEVEL == '6' }}>6 - Tout</option>
                            </select>
                            <small>Niveau de verbosit? des logs GStreamer</small>
                        </div>
                        <div class="form-group">
                            <label for="LOG_DIR">
                                <i class="fas fa-folder-open"></i> R?pertoire des logs
                            </label>
                            <input type="text" id="LOG_DIR" name="LOG_DIR" 
                                   value="{{ config.LOG_DIR }}">
                            <small>Chemin pour stocker les fichiers de log</small>
                        </div>
                        <div class="form-group">
                            <label for="LOW_LATENCY">
                                <i class="fas fa-bolt"></i> Mode faible latence
                            </label>
                            <select id="LOW_LATENCY" name="LOW_LATENCY">
                                <option value="1" {{ 'selected' if config.LOW_LATENCY == '1' }}>Activ?</option>
                                <option value="0" {{ 'selected' if config.LOW_LATENCY == '0' }}>D?sactiv?</option>
                            </select>
                            <small>Optimise pour une latence minimale du flux RTSP</small>
                        </div>
                    </div>

                    <!-- Logs Tab -->
                    <div class="tab-content" id="tab-logs">
                        <!-- Diagnostic Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-stethoscope"></i> Diagnostic du syst?me</h4>
                            <button type="button" class="btn btn-primary" onclick="runDiagnostic()">
                                <i class="fas fa-search"></i> Lancer le diagnostic
                            </button>
                            <div id="diagnostic-results" class="diagnostic-container" style="display: none; margin-top: 15px;">
                                <div class="diagnostic-section">
                                    <h5><i class="fas fa-cog"></i> Service RTSP</h5>
                                    <div id="diag-service"></div>
                                </div>
                                <div class="diagnostic-section">
                                    <h5><i class="fas fa-video"></i> GStreamer</h5>
                                    <div id="diag-gstreamer"></div>
                                </div>
                                <div class="diagnostic-section">
                                    <h5><i class="fas fa-camera"></i> Cam?ra</h5>
                                    <div id="diag-camera"></div>
                                </div>
                                <div class="diagnostic-section">
                                    <h5><i class="fas fa-microphone"></i> Audio</h5>
                                    <div id="diag-audio"></div>
                                </div>
                                <div class="diagnostic-section">
                                    <h5><i class="fas fa-network-wired"></i> R?seau</h5>
                                    <div id="diag-network"></div>
                                </div>
                                <div class="diagnostic-section errors" id="diag-errors-section" style="display: none;">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Erreurs d?tect?es</h5>
                                    <div id="diag-errors"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Logs Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-file-alt"></i> Logs du service</h4>
                            <div class="logs-controls">
                                <div class="logs-buttons">
                                    <button type="button" class="btn btn-secondary" onclick="loadLogs()">
                                        <i class="fas fa-sync"></i> Actualiser
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="exportLogs()">
                                        <i class="fas fa-file-export"></i> Export Logs
                                    </button>
                                    <button type="button" class="btn btn-primary" id="btn-live-logs" onclick="toggleLiveLogs()">
                                        <i class="fas fa-play"></i> Logs en direct
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearLogsDisplay()">
                                        <i class="fas fa-eraser"></i> Effacer l'affichage
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="cleanServerLogs()">
                                        <i class="fas fa-trash-alt"></i> Nettoyer les logs serveur
                                    </button>
                                </div>
                                <div class="logs-options">
                                    <select id="logs-source" onchange="loadLogs()">
                                        <option value="all">Toutes les sources</option>
                                        <option value="rtsp">RTSP (systemd)</option>
                                        <option value="webmanager">Web Manager (systemd)</option>
                                        <option value="recorder">Recorder (systemd)</option>
                                        <option value="watchdog">Watchdog (systemd)</option>
                                        <option value="onvif">ONVIF (systemd)</option>
                                        <option value="system">Syst?me (warnings)</option>
                                        <option value="journald">Journald (tous services)</option>
                                        <option value="file-rtsp">Fichier: rpi_av_rtsp_recorder.log</option>
                                        <option value="file-recorder">Fichier: rtsp_recorder.log</option>
                                        <option value="file-watchdog">Fichier: rtsp_watchdog.log</option>
                                        <option value="file-dnsmasq">Fichier: dnsmasq.log</option>
                                        <option value="file-gstreamer">Fichier: gstreamer*.log (dernier)</option>
                                        <option value="file-all">Fichiers: /var/log/rpi-cam/*.log</option>
                                    </select>
                                    <select id="logs-lines" onchange="loadLogs()">
                                        <option value="50">50 lignes</option>
                                        <option value="100" selected>100 lignes</option>
                                        <option value="200">200 lignes</option>
                                        <option value="500">500 lignes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="logs-status" id="logs-status">
                                <span id="logs-status-text">Pr?t</span>
                                <span id="live-indicator" class="live-indicator" style="display: none;">
                                    <i class="fas fa-circle blink"></i> LIVE
                                </span>
                            </div>
                            <pre id="logs-content" class="logs-viewer">Cliquez sur "Actualiser" pour charger les logs ou "Logs en direct" pour le streaming...</pre>
                        </div>
                    </div>

                    {% if debug_enabled %}
                    <!-- Debug Tab -->
                    <div class="tab-content" id="tab-debug">
                        <!-- Warning Banner -->
                        <div class="debug-warning-banner">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Zone de maintenance avanc?e. Ces op?rations peuvent prendre plusieurs minutes et red?marrer le syst?me.</span>
                        </div>

                        <!-- Meeting Local Config -->
                        <div class="form-section">
                            <h4><i class="fas fa-sliders-h"></i> Configuration locale (meeting.json)</h4>
                            <small class="section-help">
                                Ces r?glages pilotent le service local (heartbeat). Laissez le token vide pour ne pas le modifier.
                            </small>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>
                                        <i class="fas fa-toggle-on"></i> Activer Meeting
                                    </label>
                                    <div class="toggle-control">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="meeting_enabled_toggle">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span id="meeting-enabled-status" class="control-status">D?sactiv?</span>
                                    </div>
                                    <small>Active ou d?sactive le heartbeat Meeting</small>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <i class="fas fa-bolt"></i> Auto-connexion
                                    </label>
                                    <div class="toggle-control">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="meeting_auto_connect">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span id="meeting-auto-connect-status" class="control-status">D?sactiv?</span>
                                    </div>
                                    <small>Envoie automatiquement le heartbeat au d?marrage</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="meeting_config_api_url">
                                        <i class="fas fa-globe"></i> URL de l'API
                                    </label>
                                    <input type="text" id="meeting_config_api_url" placeholder="https://meeting.ygsoft.fr/api">
                                </div>
                                <div class="form-group">
                                    <label for="meeting_config_device_key">
                                        <i class="fas fa-key"></i> Device Key
                                    </label>
                                    <input type="text" id="meeting_config_device_key" placeholder="ABCDEF123456789...">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="meeting_config_token_code">
                                        <i class="fas fa-ticket-alt"></i> Token Code
                                    </label>
                                    <div class="input-with-button">
                                        <input type="password" id="meeting_config_token_code" placeholder="???????? (inchang? si vide)">
                                        <button type="button" class="btn btn-icon" onclick="togglePassword('meeting_config_token_code')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small>Le token n'est modifi? que si ce champ est rempli</small>
                                </div>
                                <div class="form-group">
                                    <label for="meeting_config_heartbeat_interval">
                                        <i class="fas fa-heartbeat"></i> Intervalle Heartbeat (s)
                                    </label>
                                    <input type="number" id="meeting_config_heartbeat_interval" min="10" max="300" value="30">
                                    <small>Fr?quence d'envoi du heartbeat</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <i class="fas fa-shield-alt"></i> Provisionn?
                                </label>
                                <span id="meeting_config_provisioned" class="badge badge-info">-</span>
                            </div>
                            
                            <div class="button-group">
                                <button type="button" class="btn btn-primary" onclick="saveMeetingConfig()">
                                    <i class="fas fa-save"></i> Sauvegarder
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="loadMeetingConfig()">
                                    <i class="fas fa-sync"></i> Rafra?chir
                                </button>
                            </div>
                        </div>

                        <!-- RTC Debug Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-clock"></i> Horloge RTC (DS3231)</h4>
                            <small class="section-help">
                                Statut et diagnostics de l'horloge mat?rielle (RTC).
                            </small>
                            <div class="debug-action-card">
                                <div class="debug-action-info">
                                    <div class="debug-action-status" id="rtc-debug-status">
                                        <span class="status-label">?tat:</span>
                                        <span class="status-value" id="rtc-debug-status-text">Chargement...</span>
                                    </div>
                                    <div class="debug-action-details" id="rtc-debug-details">
                                        <small>Cliquez sur "Rafra?chir" pour obtenir les d?tails RTC</small>
                                    </div>
                                </div>
                                <div class="debug-action-buttons">
                                    <button type="button" class="btn btn-secondary" onclick="loadRtcDebug()">
                                        <i class="fas fa-sync"></i> Rafra?chir
                                    </button>
                                </div>
                            </div>
                            <div class="debug-output-container" id="rtc-output-container" style="display: none;">
                                <div class="debug-output-header">
                                    <span><i class="fas fa-terminal"></i> D?tails RTC</span>
                                    <button type="button" class="btn-icon" onclick="toggleDebugOutput('rtc')">
                                        <i class="fas fa-chevron-down" id="rtc-output-toggle"></i>
                                    </button>
                                </div>
                                <pre class="debug-output" id="rtc-debug-output"></pre>
                            </div>
                        </div>

                        <!-- Firmware Update Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-microchip"></i> Mise ? jour Firmware Raspberry Pi</h4>
                            <small class="section-help">
                                <strong>Pi 4/5:</strong> EEPROM bootloader via <code>rpi-eeprom-update</code><br>
                                <strong>Pi 3/2/Zero:</strong> Kernel/firmware via <code>rpi-update</code> (exp?rimental)
                            </small>
                            <div class="debug-action-card">
                                <div class="debug-action-info">
                                    <div class="debug-action-status" id="firmware-status">
                                        <span class="status-label">?tat:</span>
                                        <span class="status-value" id="firmware-status-text">Non v?rifi?</span>
                                    </div>
                                    <div class="debug-action-details" id="firmware-details">
                                        <small>Cliquez sur "V?rifier" pour voir les mises ? jour disponibles</small>
                                    </div>
                                    <div class="debug-action-last-run" id="firmware-last-run">
                                        <small><i class="fas fa-history"></i> Derni?re v?rification: <span id="firmware-last-date">jamais</span></small>
                                    </div>
                                    <div class="debug-action-method" id="firmware-method" style="display: none;">
                                        <span class="badge badge-info" id="firmware-method-badge"></span>
                                    </div>
                                </div>
                                <div class="debug-action-buttons">
                                    <button type="button" class="btn btn-secondary" onclick="checkFirmwareUpdate()" id="btn-check-firmware">
                                        <i class="fas fa-search"></i> V?rifier
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="runFirmwareUpdate()" id="btn-update-firmware" disabled>
                                        <i class="fas fa-download"></i> Mettre ? jour
                                    </button>
                                </div>
                            </div>
                            <div class="debug-output-container" id="firmware-output-container" style="display: none;">
                                <div class="debug-output-header">
                                    <span><i class="fas fa-terminal"></i> Sortie de la commande</span>
                                    <button type="button" class="btn-icon" onclick="toggleDebugOutput('firmware')">
                                        <i class="fas fa-chevron-down" id="firmware-output-toggle"></i>
                                    </button>
                                </div>
                                <pre class="debug-output" id="firmware-output"></pre>
                            </div>
                        </div>

                        <!-- APT Update Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-sync-alt"></i> Mise ? jour des listes de paquets (apt update)</h4>
                            <small class="section-help">
                                Rafra?chit la liste des paquets disponibles depuis les d?p?ts. Ne modifie pas les paquets install?s.
                            </small>
                            <div class="debug-action-card">
                                <div class="debug-action-info">
                                    <div class="debug-action-status" id="apt-update-status">
                                        <span class="status-label">?tat:</span>
                                        <span class="status-value" id="apt-update-status-text">Non ex?cut?</span>
                                    </div>
                                    <div class="debug-action-details" id="apt-update-details">
                                        <small>Rafra?chit les listes de paquets</small>
                                    </div>
                                    <div class="debug-action-last-run" id="apt-update-last-run">
                                        <small><i class="fas fa-history"></i> Derni?re ex?cution: <span id="apt-update-last-date">jamais</span></small>
                                    </div>
                                </div>
                                <div class="debug-action-buttons">
                                    <button type="button" class="btn btn-primary" onclick="runAptUpdate()" id="btn-apt-update">
                                        <i class="fas fa-sync"></i> Ex?cuter apt update
                                    </button>
                                </div>
                            </div>
                            <div class="debug-output-container" id="apt-update-output-container" style="display: none;">
                                <div class="debug-output-header">
                                    <span><i class="fas fa-terminal"></i> Sortie de la commande</span>
                                    <button type="button" class="btn-icon" onclick="toggleDebugOutput('apt-update')">
                                        <i class="fas fa-chevron-down" id="apt-update-output-toggle"></i>
                                    </button>
                                </div>
                                <pre class="debug-output" id="apt-update-output"></pre>
                            </div>
                        </div>

                        <!-- APT Upgrade Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-arrow-up"></i> Mise ? jour des paquets (apt upgrade)</h4>
                            <small class="section-help">
                                Installe les mises ? jour disponibles pour tous les paquets. Peut prendre plusieurs minutes.
                            </small>
                            <div class="debug-action-card">
                                <div class="debug-action-info">
                                    <div class="debug-action-status" id="apt-upgrade-status">
                                        <span class="status-label">?tat:</span>
                                        <span class="status-value" id="apt-upgrade-status-text">Non v?rifi?</span>
                                    </div>
                                    <div class="debug-action-details" id="apt-upgrade-details">
                                        <small>Ex?cutez d'abord "apt update" pour v?rifier les mises ? jour</small>
                                    </div>
                                    <div class="debug-action-last-run" id="apt-upgrade-last-run">
                                        <small><i class="fas fa-history"></i> Derni?re ex?cution: <span id="apt-upgrade-last-date">jamais</span></small>
                                    </div>
                                </div>
                                <div class="debug-action-buttons">
                                    <button type="button" class="btn btn-secondary" onclick="checkAptUpgradable()" id="btn-check-upgradable">
                                        <i class="fas fa-list"></i> Voir paquets
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="runAptUpgrade()" id="btn-apt-upgrade">
                                        <i class="fas fa-arrow-up"></i> Mettre ? jour
                                    </button>
                                </div>
                            </div>
                            <div class="debug-output-container" id="apt-upgrade-output-container" style="display: none;">
                                <div class="debug-output-header">
                                    <span><i class="fas fa-terminal"></i> Sortie de la commande</span>
                                    <button type="button" class="btn-icon" onclick="toggleDebugOutput('apt-upgrade')">
                                        <i class="fas fa-chevron-down" id="apt-upgrade-output-toggle"></i>
                                    </button>
                                </div>
                                <pre class="debug-output" id="apt-upgrade-output"></pre>
                            </div>
                        </div>

                        <!-- APT Auto-Update Scheduler Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-calendar-alt"></i> Mises ? jour automatiques (Scheduler)</h4>
                            <small class="section-help">
                                Planifiez l'ex?cution automatique de apt update et apt upgrade. Les logs sont disponibles dans <code>/var/log/rpi-cam/apt-autoupdate.log</code>
                            </small>
                            <div class="scheduler-card">
                                <div class="scheduler-toggle">
                                    <div class="scheduler-info">
                                        <strong><i class="fas fa-clock"></i> Activer les mises ? jour automatiques</strong>
                                        <small id="scheduler-status-text">D?sactiv?</small>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="apt-scheduler-enabled" onchange="toggleAptScheduler()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="scheduler-config" id="scheduler-config" style="display: none;">
                                    <div class="scheduler-row">
                                        <label><i class="fas fa-sync-alt"></i> apt update quotidien ?:</label>
                                        <div class="time-picker">
                                            <select id="scheduler-update-hour">
                                                {% for h in range(24) %}
                                                <option value="{{ h }}" {{ 'selected' if h == 3 else '' }}>{{ '%02d'|format(h) }}</option>
                                                {% endfor %}
                                            </select>
                                            <span>:</span>
                                            <select id="scheduler-update-minute">
                                                <option value="0" selected>00</option>
                                                <option value="15">15</option>
                                                <option value="30">30</option>
                                                <option value="45">45</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="scheduler-row">
                                        <label>
                                            <input type="checkbox" id="scheduler-upgrade-enabled" onchange="updateSchedulerConfig()">
                                            <i class="fas fa-arrow-up"></i> Activer apt upgrade hebdomadaire
                                        </label>
                                    </div>
                                    
                                    <div class="scheduler-row" id="scheduler-upgrade-day-row" style="display: none;">
                                        <label><i class="fas fa-calendar-week"></i> Jour de la semaine:</label>
                                        <select id="scheduler-upgrade-day" onchange="updateSchedulerConfig()">
                                            <option value="0">Dimanche</option>
                                            <option value="1">Lundi</option>
                                            <option value="2">Mardi</option>
                                            <option value="3">Mercredi</option>
                                            <option value="4">Jeudi</option>
                                            <option value="5">Vendredi</option>
                                            <option value="6">Samedi</option>
                                        </select>
                                    </div>
                                    
                                    <div class="scheduler-actions">
                                        <button type="button" class="btn btn-primary" onclick="saveAptScheduler()" id="btn-save-scheduler">
                                            <i class="fas fa-save"></i> Enregistrer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Web Terminal Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-terminal"></i> Terminal</h4>
                            <small class="section-help">
                                Console de commandes s?curis?e. Seules certaines commandes syst?me sont autoris?es.
                            </small>
                            <div class="terminal-container">
                                <div class="terminal-output" id="terminal-output">
                                    <div class="terminal-line terminal-info">
                                        <span>Bienvenue dans le terminal web RTSP Recorder.</span>
                                    </div>
                                    <div class="terminal-line terminal-info">
                                        <span>Tapez "help" pour voir les commandes autoris?es.</span>
                                    </div>
                                </div>
                                <div class="terminal-input-line">
                                    <span class="terminal-prompt">device@rpi:~$</span>
                                    <input type="text" id="terminal-input" class="terminal-input" 
                                           placeholder="Entrez une commande..." 
                                           autocomplete="off" spellcheck="false"
                                           onkeydown="handleTerminalKeydown(event)">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="executeTerminalCommand()">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                <div class="terminal-toolbar">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearTerminal()">
                                        <i class="fas fa-eraser"></i> Effacer
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="showAllowedCommands()">
                                        <i class="fas fa-question-circle"></i> Aide
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- System Reboot Section -->
                        <div class="form-section">
                            <h4><i class="fas fa-power-off"></i> Red?marrage syst?me</h4>
                            <small class="section-help">
                                Red?marre le Raspberry Pi. N?cessaire apr?s certaines mises ? jour (firmware, kernel).
                            </small>
                            <div class="debug-action-card danger">
                                <div class="debug-action-info">
                                    <div class="debug-action-status">
                                        <span class="status-label">Uptime:</span>
                                        <span class="status-value" id="system-uptime">Chargement...</span>
                                    </div>
                                </div>
                                <div class="debug-action-buttons">
                                    <button type="button" class="btn btn-danger" onclick="confirmReboot()">
                                        <i class="fas fa-redo"></i> Red?marrer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    </div>
                </form>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>RTSP Recorder v{{ app_version }} | Interface de gestion</p>
        </footer>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Camera Profile Modal -->
    <div id="profile-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-clock"></i> <span id="profile-modal-title">Nouveau profil</span></h3>
                <button type="button" class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profile-form" onsubmit="saveProfile(event)">
                    <input type="hidden" id="profile-id" value="">
                    
                    <div class="form-group">
                        <label for="profile-name">
                            <i class="fas fa-tag"></i> Nom du profil
                        </label>
                        <input type="text" id="profile-name" required placeholder="ex: Jour, Nuit, IR...">
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-description">
                            <i class="fas fa-info-circle"></i> Description
                        </label>
                        <input type="text" id="profile-description" placeholder="Description optionnelle">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profile-start">
                                <i class="fas fa-sun"></i> Heure de d?but
                            </label>
                            <input type="time" id="profile-start" value="07:00">
                        </div>
                        <div class="form-group">
                            <label for="profile-end">
                                <i class="fas fa-moon"></i> Heure de fin
                            </label>
                            <input type="time" id="profile-end" value="19:00">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <i class="fas fa-power-off"></i> Profil actif
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="profile-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <i class="fas fa-camera"></i> R?glages cam?ra
                        </label>
                        <div class="profile-controls-info">
                            <span id="profile-controls-count">0 r?glages enregistr?s</span>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="captureCurrentSettings()">
                                <i class="fas fa-camera"></i> Capturer r?glages actuels
                            </button>
                        </div>
                        <small>Cliquez sur "Capturer" pour enregistrer les r?glages cam?ra actuels dans ce profil</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-primary" onclick="saveProfile(event)">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <div id="profile-settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cogs"></i> <span id="profile-settings-title">Param?tres profil</span></h3>
                <button type="button" class="modal-close" onclick="closeProfileSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-settings-meta" id="profile-settings-meta"></div>
                <div id="profile-settings-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProfileSettingsModal()">Fermer</button>
            </div>
        </div>
    </div>

    <div id="update-repo-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fab fa-github"></i> Update depuis repo</h3>
                <button type="button" class="modal-close" onclick="closeUpdateRepoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="status-row">
                    <span>Version actuelle</span>
                    <span id="update-repo-current-version">-</span>
                </div>
                <div class="status-row">
                    <span>Version disponible</span>
                    <span id="update-repo-latest-version">-</span>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="update-repo-force" onchange="updateRepoApplyState()">
                        Forcer la reinstallation si meme version
                    </label>
                    <small>Utile en cas de fichiers corrompus ou deploiement incomplet.</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="update-repo-reset">
                        Reset settings (reinitialiser la configuration)
                    </label>
                    <small>Supprime la configuration locale pour repartir sur une version propre.</small>
                </div>

                <div class="debug-action-status" id="update-repo-status">
                    <span class="status-label">Statut:</span>
                    <span class="status-spinner" id="update-repo-status-spinner" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                    <span class="status-value" id="update-repo-status-text">En attente</span>
                </div>

                <div class="update-log" id="update-repo-log" style="display: none;">
                    <pre></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUpdateRepoModal()">Fermer</button>
                <button type="button" class="btn btn-primary" id="update-repo-apply-btn" onclick="applyUpdateRepo()" disabled>
                    <i class="fas fa-check"></i> Appliquer
                </button>
            </div>
        </div>
    </div>

    <div id="update-file-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-upload"></i> Update depuis fichier</h3>
                <button type="button" class="modal-close" onclick="closeUpdateFileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="status-row">
                    <span>Fichier</span>
                    <span id="update-file-name">-</span>
                </div>
                <div class="status-row">
                    <span>Version actuelle</span>
                    <span id="update-current-version">-</span>
                </div>
                <div class="status-row">
                    <span>Version update</span>
                    <span id="update-new-version">-</span>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="update-file-force" onchange="onUpdateFileForceChanged()">
                        Forcer la reinstallation si meme version
                    </label>
                    <small>Utile en cas de fichiers corrompus ou deploiement incomplet.</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="update-file-reset">
                        Reset settings (reinitialiser la configuration)
                    </label>
                    <small>Supprime la configuration locale pour repartir sur une version propre.</small>
                </div>
                <div class="form-group" id="update-file-deps-group" style="display: none;">
                    <label>Dependances manquantes detectees</label>
                    <small>Installation automatique + redemarrage requis.</small>
                    <small id="update-file-deps-info"></small>
                </div>

                <div class="debug-action-status" id="update-file-status">
                    <span class="status-label">Statut:</span>
                    <span class="status-spinner" id="update-file-status-spinner" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                    <span class="status-value" id="update-file-status-text">En attente</span>
                </div>

                <div class="update-log" id="update-file-log" style="display: none;">
                    <pre></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUpdateFileModal()">Fermer</button>
                <button type="button" class="btn btn-primary" id="update-file-apply-btn" onclick="applyUpdateFile()" disabled>
                    <i class="fas fa-check"></i> Appliquer
                </button>
            </div>
        </div>
    </div>

    <script>window.APP_VERSION = "{{ app_version }}";</script>
    <script src="{{ url_for('static', filename='js/modules/ui_utils.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/utils.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/navigation.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/home_status.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/logs.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/recordings.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/network.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/power.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/updates.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/meeting.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/camera.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/config_video.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/modules/diagnostics.js') }}?v={{ app_version }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}?v={{ app_version }}"></script>
</body>
</html>










